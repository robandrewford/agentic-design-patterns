"use strict";var lo=Object.create;var gt=Object.defineProperty;var fo=Object.getOwnPropertyDescriptor;var ho=Object.getOwnPropertyNames;var po=Object.getPrototypeOf,mo=Object.prototype.hasOwnProperty;var R=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),_o=(r,e)=>{for(var t in e)gt(r,t,{get:e[t],enumerable:!0})},Yn=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ho(e))!mo.call(r,s)&&s!==t&&gt(r,s,{get:()=>e[s],enumerable:!(n=fo(e,s))||n.enumerable});return r};var ee=(r,e,t)=>(t=r!=null?lo(po(r)):{},Yn(e||!r||!r.__esModule?gt(t,"default",{value:r,enumerable:!0}):t,r)),go=r=>Yn(gt({},"__esModule",{value:!0}),r);var Zn=R((Pc,Qn)=>{"use strict";function yo(r,e){var t=r;e.slice(0,-1).forEach(function(s){t=t[s]||{}});var n=e[e.length-1];return n in t}function Kn(r){return typeof r=="number"||/^0x[0-9a-f]+$/i.test(r)?!0:/^[-+]?(?:\d+(?:\.\d*)?|\.\d+)(e[-+]?\d+)?$/.test(r)}function Xn(r,e){return e==="constructor"&&typeof r[e]=="function"||e==="__proto__"}Qn.exports=function(r,e){e||(e={});var t={bools:{},strings:{},unknownFn:null};typeof e.unknown=="function"&&(t.unknownFn=e.unknown),typeof e.boolean=="boolean"&&e.boolean?t.allBools=!0:[].concat(e.boolean).filter(Boolean).forEach(function(b){t.bools[b]=!0});var n={};function s(b){return n[b].some(function(E){return t.bools[E]})}Object.keys(e.alias||{}).forEach(function(b){n[b]=[].concat(e.alias[b]),n[b].forEach(function(E){n[E]=[b].concat(n[b].filter(function(F){return E!==F}))})}),[].concat(e.string).filter(Boolean).forEach(function(b){t.strings[b]=!0,n[b]&&[].concat(n[b]).forEach(function(E){t.strings[E]=!0})});var i=e.default||{},a={_:[]};function f(b,E){return t.allBools&&/^--[^=]+$/.test(E)||t.strings[b]||t.bools[b]||n[b]}function h(b,E,F){for(var C=b,ae=0;ae<E.length-1;ae++){var J=E[ae];if(Xn(C,J))return;C[J]===void 0&&(C[J]={}),(C[J]===Object.prototype||C[J]===Number.prototype||C[J]===String.prototype)&&(C[J]={}),C[J]===Array.prototype&&(C[J]=[]),C=C[J]}var Z=E[E.length-1];Xn(C,Z)||((C===Object.prototype||C===Number.prototype||C===String.prototype)&&(C={}),C===Array.prototype&&(C=[]),C[Z]===void 0||t.bools[Z]||typeof C[Z]=="boolean"?C[Z]=F:Array.isArray(C[Z])?C[Z].push(F):C[Z]=[C[Z],F])}function l(b,E,F){if(!(F&&t.unknownFn&&!f(b,F)&&t.unknownFn(F)===!1)){var C=!t.strings[b]&&Kn(E)?Number(E):E;h(a,b.split("."),C),(n[b]||[]).forEach(function(ae){h(a,ae.split("."),C)})}}Object.keys(t.bools).forEach(function(b){l(b,i[b]===void 0?!1:i[b])});var g=[];r.indexOf("--")!==-1&&(g=r.slice(r.indexOf("--")+1),r=r.slice(0,r.indexOf("--")));for(var p=0;p<r.length;p++){var m=r[p],S,O;if(/^--.+=/.test(m)){var w=m.match(/^--([^=]+)=([\s\S]*)$/);S=w[1];var L=w[2];t.bools[S]&&(L=L!=="false"),l(S,L,m)}else if(/^--no-.+/.test(m))S=m.match(/^--no-(.+)/)[1],l(S,!1,m);else if(/^--.+/.test(m))S=m.match(/^--(.+)/)[1],O=r[p+1],O!==void 0&&!/^(-|--)[^-]/.test(O)&&!t.bools[S]&&!t.allBools&&(!n[S]||!s(S))?(l(S,O,m),p+=1):/^(true|false)$/.test(O)?(l(S,O==="true",m),p+=1):l(S,t.strings[S]?"":!0,m);else if(/^-[^-]+/.test(m)){for(var $=m.slice(1,-1).split(""),G=!1,x=0;x<$.length;x++){if(O=m.slice(x+2),O==="-"){l($[x],O,m);continue}if(/[A-Za-z]/.test($[x])&&O[0]==="="){l($[x],O.slice(1),m),G=!0;break}if(/[A-Za-z]/.test($[x])&&/-?\d+(\.\d*)?(e-?\d+)?$/.test(O)){l($[x],O,m),G=!0;break}if($[x+1]&&$[x+1].match(/\W/)){l($[x],m.slice(x+2),m),G=!0;break}else l($[x],t.strings[$[x]]?"":!0,m)}S=m.slice(-1)[0],!G&&S!=="-"&&(r[p+1]&&!/^(-|--)[^-]/.test(r[p+1])&&!t.bools[S]&&(!n[S]||!s(S))?(l(S,r[p+1],m),p+=1):r[p+1]&&/^(true|false)$/.test(r[p+1])?(l(S,r[p+1]==="true",m),p+=1):l(S,t.strings[S]?"":!0,m))}else if((!t.unknownFn||t.unknownFn(m)!==!1)&&a._.push(t.strings._||!Kn(m)?m:Number(m)),e.stopEarly){a._.push.apply(a._,r.slice(p+1));break}}return Object.keys(i).forEach(function(b){yo(a,b.split("."))||(h(a,b.split("."),i[b]),(n[b]||[]).forEach(function(E){h(a,E.split("."),i[b])}))}),e["--"]?a["--"]=g.slice():g.forEach(function(b){a._.push(b)}),a}});var qe=R(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});K.stringArray=K.array=K.func=K.error=K.number=K.string=K.boolean=void 0;function bo(r){return r===!0||r===!1}K.boolean=bo;function es(r){return typeof r=="string"||r instanceof String}K.string=es;function So(r){return typeof r=="number"||r instanceof Number}K.number=So;function vo(r){return r instanceof Error}K.error=vo;function Eo(r){return typeof r=="function"}K.func=Eo;function ts(r){return Array.isArray(r)}K.array=ts;function wo(r){return ts(r)&&r.every(e=>es(e))}K.stringArray=wo});var Cr=R(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.Message=y.NotificationType9=y.NotificationType8=y.NotificationType7=y.NotificationType6=y.NotificationType5=y.NotificationType4=y.NotificationType3=y.NotificationType2=y.NotificationType1=y.NotificationType0=y.NotificationType=y.RequestType9=y.RequestType8=y.RequestType7=y.RequestType6=y.RequestType5=y.RequestType4=y.RequestType3=y.RequestType2=y.RequestType1=y.RequestType=y.RequestType0=y.AbstractMessageSignature=y.ParameterStructures=y.ResponseError=y.ErrorCodes=void 0;var Oe=qe(),nr;(function(r){r.ParseError=-32700,r.InvalidRequest=-32600,r.MethodNotFound=-32601,r.InvalidParams=-32602,r.InternalError=-32603,r.jsonrpcReservedErrorRangeStart=-32099,r.serverErrorStart=-32099,r.MessageWriteError=-32099,r.MessageReadError=-32098,r.PendingResponseRejected=-32097,r.ConnectionInactive=-32096,r.ServerNotInitialized=-32002,r.UnknownErrorCode=-32001,r.jsonrpcReservedErrorRangeEnd=-32e3,r.serverErrorEnd=-32e3})(nr||(y.ErrorCodes=nr={}));var sr=class r extends Error{constructor(e,t,n){super(t),this.code=Oe.number(e)?e:nr.UnknownErrorCode,this.data=n,Object.setPrototypeOf(this,r.prototype)}toJson(){let e={code:this.code,message:this.message};return this.data!==void 0&&(e.data=this.data),e}};y.ResponseError=sr;var te=class r{constructor(e){this.kind=e}static is(e){return e===r.auto||e===r.byName||e===r.byPosition}toString(){return this.kind}};y.ParameterStructures=te;te.auto=new te("auto");te.byPosition=new te("byPosition");te.byName=new te("byName");var B=class{constructor(e,t){this.method=e,this.numberOfParams=t}get parameterStructures(){return te.auto}};y.AbstractMessageSignature=B;var ir=class extends B{constructor(e){super(e,0)}};y.RequestType0=ir;var or=class extends B{constructor(e,t=te.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.RequestType=or;var ar=class extends B{constructor(e,t=te.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.RequestType1=ar;var cr=class extends B{constructor(e){super(e,2)}};y.RequestType2=cr;var ur=class extends B{constructor(e){super(e,3)}};y.RequestType3=ur;var lr=class extends B{constructor(e){super(e,4)}};y.RequestType4=lr;var fr=class extends B{constructor(e){super(e,5)}};y.RequestType5=fr;var dr=class extends B{constructor(e){super(e,6)}};y.RequestType6=dr;var hr=class extends B{constructor(e){super(e,7)}};y.RequestType7=hr;var pr=class extends B{constructor(e){super(e,8)}};y.RequestType8=pr;var mr=class extends B{constructor(e){super(e,9)}};y.RequestType9=mr;var _r=class extends B{constructor(e,t=te.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.NotificationType=_r;var gr=class extends B{constructor(e){super(e,0)}};y.NotificationType0=gr;var yr=class extends B{constructor(e,t=te.auto){super(e,1),this._parameterStructures=t}get parameterStructures(){return this._parameterStructures}};y.NotificationType1=yr;var br=class extends B{constructor(e){super(e,2)}};y.NotificationType2=br;var Sr=class extends B{constructor(e){super(e,3)}};y.NotificationType3=Sr;var vr=class extends B{constructor(e){super(e,4)}};y.NotificationType4=vr;var Er=class extends B{constructor(e){super(e,5)}};y.NotificationType5=Er;var wr=class extends B{constructor(e){super(e,6)}};y.NotificationType6=wr;var xr=class extends B{constructor(e){super(e,7)}};y.NotificationType7=xr;var Tr=class extends B{constructor(e){super(e,8)}};y.NotificationType8=Tr;var Or=class extends B{constructor(e){super(e,9)}};y.NotificationType9=Or;var rs;(function(r){function e(s){let i=s;return i&&Oe.string(i.method)&&(Oe.string(i.id)||Oe.number(i.id))}r.isRequest=e;function t(s){let i=s;return i&&Oe.string(i.method)&&s.id===void 0}r.isNotification=t;function n(s){let i=s;return i&&(i.result!==void 0||!!i.error)&&(Oe.string(i.id)||Oe.number(i.id)||i.id===null)}r.isResponse=n})(rs||(y.Message=rs={}))});var kr=R(be=>{"use strict";var ns;Object.defineProperty(be,"__esModule",{value:!0});be.LRUCache=be.LinkedMap=be.Touch=void 0;var X;(function(r){r.None=0,r.First=1,r.AsOld=r.First,r.Last=2,r.AsNew=r.Last})(X||(be.Touch=X={}));var yt=class{constructor(){this[ns]="LinkedMap",this._map=new Map,this._head=void 0,this._tail=void 0,this._size=0,this._state=0}clear(){this._map.clear(),this._head=void 0,this._tail=void 0,this._size=0,this._state++}isEmpty(){return!this._head&&!this._tail}get size(){return this._size}get first(){var e;return(e=this._head)==null?void 0:e.value}get last(){var e;return(e=this._tail)==null?void 0:e.value}has(e){return this._map.has(e)}get(e,t=X.None){let n=this._map.get(e);if(n)return t!==X.None&&this.touch(n,t),n.value}set(e,t,n=X.None){let s=this._map.get(e);if(s)s.value=t,n!==X.None&&this.touch(s,n);else{switch(s={key:e,value:t,next:void 0,previous:void 0},n){case X.None:this.addItemLast(s);break;case X.First:this.addItemFirst(s);break;case X.Last:this.addItemLast(s);break;default:this.addItemLast(s);break}this._map.set(e,s),this._size++}return this}delete(e){return!!this.remove(e)}remove(e){let t=this._map.get(e);if(t)return this._map.delete(e),this.removeItem(t),this._size--,t.value}shift(){if(!this._head&&!this._tail)return;if(!this._head||!this._tail)throw new Error("Invalid list");let e=this._head;return this._map.delete(e.key),this.removeItem(e),this._size--,e.value}forEach(e,t){let n=this._state,s=this._head;for(;s;){if(t?e.bind(t)(s.value,s.key,this):e(s.value,s.key,this),this._state!==n)throw new Error("LinkedMap got modified during iteration.");s=s.next}}keys(){let e=this._state,t=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(t){let s={value:t.key,done:!1};return t=t.next,s}else return{value:void 0,done:!0}}};return n}values(){let e=this._state,t=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(t){let s={value:t.value,done:!1};return t=t.next,s}else return{value:void 0,done:!0}}};return n}entries(){let e=this._state,t=this._head,n={[Symbol.iterator]:()=>n,next:()=>{if(this._state!==e)throw new Error("LinkedMap got modified during iteration.");if(t){let s={value:[t.key,t.value],done:!1};return t=t.next,s}else return{value:void 0,done:!0}}};return n}[(ns=Symbol.toStringTag,Symbol.iterator)](){return this.entries()}trimOld(e){if(e>=this.size)return;if(e===0){this.clear();return}let t=this._head,n=this.size;for(;t&&n>e;)this._map.delete(t.key),t=t.next,n--;this._head=t,this._size=n,t&&(t.previous=void 0),this._state++}addItemFirst(e){if(!this._head&&!this._tail)this._tail=e;else if(this._head)e.next=this._head,this._head.previous=e;else throw new Error("Invalid list");this._head=e,this._state++}addItemLast(e){if(!this._head&&!this._tail)this._head=e;else if(this._tail)e.previous=this._tail,this._tail.next=e;else throw new Error("Invalid list");this._tail=e,this._state++}removeItem(e){if(e===this._head&&e===this._tail)this._head=void 0,this._tail=void 0;else if(e===this._head){if(!e.next)throw new Error("Invalid list");e.next.previous=void 0,this._head=e.next}else if(e===this._tail){if(!e.previous)throw new Error("Invalid list");e.previous.next=void 0,this._tail=e.previous}else{let t=e.next,n=e.previous;if(!t||!n)throw new Error("Invalid list");t.previous=n,n.next=t}e.next=void 0,e.previous=void 0,this._state++}touch(e,t){if(!this._head||!this._tail)throw new Error("Invalid list");if(!(t!==X.First&&t!==X.Last)){if(t===X.First){if(e===this._head)return;let n=e.next,s=e.previous;e===this._tail?(s.next=void 0,this._tail=s):(n.previous=s,s.next=n),e.previous=void 0,e.next=this._head,this._head.previous=e,this._head=e,this._state++}else if(t===X.Last){if(e===this._tail)return;let n=e.next,s=e.previous;e===this._head?(n.previous=void 0,this._head=n):(n.previous=s,s.next=n),e.next=void 0,e.previous=this._tail,this._tail.next=e,this._tail=e,this._state++}}}toJSON(){let e=[];return this.forEach((t,n)=>{e.push([n,t])}),e}fromJSON(e){this.clear();for(let[t,n]of e)this.set(t,n)}};be.LinkedMap=yt;var Pr=class extends yt{constructor(e,t=1){super(),this._limit=e,this._ratio=Math.min(Math.max(0,t),1)}get limit(){return this._limit}set limit(e){this._limit=e,this.checkTrim()}get ratio(){return this._ratio}set ratio(e){this._ratio=Math.min(Math.max(0,e),1),this.checkTrim()}get(e,t=X.AsNew){return super.get(e,t)}peek(e){return super.get(e,X.None)}set(e,t){return super.set(e,t,X.Last),this.checkTrim(),this}checkTrim(){this.size>this._limit&&this.trimOld(Math.round(this._limit*this._ratio))}};be.LRUCache=Pr});var is=R(bt=>{"use strict";Object.defineProperty(bt,"__esModule",{value:!0});bt.Disposable=void 0;var ss;(function(r){function e(t){return{dispose:t}}r.create=e})(ss||(bt.Disposable=ss={}))});var Se=R(Lr=>{"use strict";Object.defineProperty(Lr,"__esModule",{value:!0});var Rr;function Nr(){if(Rr===void 0)throw new Error("No runtime abstraction layer installed");return Rr}(function(r){function e(t){if(t===void 0)throw new Error("No runtime abstraction layer provided");Rr=t}r.install=e})(Nr||(Nr={}));Lr.default=Nr});var Ae=R(Be=>{"use strict";Object.defineProperty(Be,"__esModule",{value:!0});Be.Emitter=Be.Event=void 0;var xo=Se(),os;(function(r){let e={dispose(){}};r.None=function(){return e}})(os||(Be.Event=os={}));var Mr=class{add(e,t=null,n){this._callbacks||(this._callbacks=[],this._contexts=[]),this._callbacks.push(e),this._contexts.push(t),Array.isArray(n)&&n.push({dispose:()=>this.remove(e,t)})}remove(e,t=null){if(!this._callbacks)return;let n=!1;for(let s=0,i=this._callbacks.length;s<i;s++)if(this._callbacks[s]===e)if(this._contexts[s]===t){this._callbacks.splice(s,1),this._contexts.splice(s,1);return}else n=!0;if(n)throw new Error("When adding a listener with a context, you should remove it with the same context")}invoke(...e){if(!this._callbacks)return[];let t=[],n=this._callbacks.slice(0),s=this._contexts.slice(0);for(let i=0,a=n.length;i<a;i++)try{t.push(n[i].apply(s[i],e))}catch(f){(0,xo.default)().console.error(f)}return t}isEmpty(){return!this._callbacks||this._callbacks.length===0}dispose(){this._callbacks=void 0,this._contexts=void 0}},St=class r{constructor(e){this._options=e}get event(){return this._event||(this._event=(e,t,n)=>{this._callbacks||(this._callbacks=new Mr),this._options&&this._options.onFirstListenerAdd&&this._callbacks.isEmpty()&&this._options.onFirstListenerAdd(this),this._callbacks.add(e,t);let s={dispose:()=>{this._callbacks&&(this._callbacks.remove(e,t),s.dispose=r._noop,this._options&&this._options.onLastListenerRemove&&this._callbacks.isEmpty()&&this._options.onLastListenerRemove(this))}};return Array.isArray(n)&&n.push(s),s}),this._event}fire(e){this._callbacks&&this._callbacks.invoke.call(this._callbacks,e)}dispose(){this._callbacks&&(this._callbacks.dispose(),this._callbacks=void 0)}};Be.Emitter=St;St._noop=function(){}});var wt=R($e=>{"use strict";Object.defineProperty($e,"__esModule",{value:!0});$e.CancellationTokenSource=$e.CancellationToken=void 0;var To=Se(),Oo=qe(),jr=Ae(),vt;(function(r){r.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:jr.Event.None}),r.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:jr.Event.None});function e(t){let n=t;return n&&(n===r.None||n===r.Cancelled||Oo.boolean(n.isCancellationRequested)&&!!n.onCancellationRequested)}r.is=e})(vt||($e.CancellationToken=vt={}));var Co=Object.freeze(function(r,e){let t=(0,To.default)().timer.setTimeout(r.bind(e),0);return{dispose(){t.dispose()}}}),Et=class{constructor(){this._isCancelled=!1}cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?Co:(this._emitter||(this._emitter=new jr.Emitter),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=void 0)}},Ir=class{get token(){return this._token||(this._token=new Et),this._token}cancel(){this._token?this._token.cancel():this._token=vt.Cancelled}dispose(){this._token?this._token instanceof Et&&this._token.dispose():this._token=vt.None}};$e.CancellationTokenSource=Ir});var as=R(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});We.SharedArrayReceiverStrategy=We.SharedArraySenderStrategy=void 0;var Po=wt(),rt;(function(r){r.Continue=0,r.Cancelled=1})(rt||(rt={}));var Dr=class{constructor(){this.buffers=new Map}enableCancellation(e){if(e.id===null)return;let t=new SharedArrayBuffer(4),n=new Int32Array(t,0,1);n[0]=rt.Continue,this.buffers.set(e.id,t),e.$cancellationData=t}async sendCancellation(e,t){let n=this.buffers.get(t);if(n===void 0)return;let s=new Int32Array(n,0,1);Atomics.store(s,0,rt.Cancelled)}cleanup(e){this.buffers.delete(e)}dispose(){this.buffers.clear()}};We.SharedArraySenderStrategy=Dr;var qr=class{constructor(e){this.data=new Int32Array(e,0,1)}get isCancellationRequested(){return Atomics.load(this.data,0)===rt.Cancelled}get onCancellationRequested(){throw new Error("Cancellation over SharedArrayBuffer doesn't support cancellation events")}},Br=class{constructor(e){this.token=new qr(e)}cancel(){}dispose(){}},Ar=class{constructor(){this.kind="request"}createCancellationTokenSource(e){let t=e.$cancellationData;return t===void 0?new Po.CancellationTokenSource:new Br(t)}};We.SharedArrayReceiverStrategy=Ar});var Wr=R(xt=>{"use strict";Object.defineProperty(xt,"__esModule",{value:!0});xt.Semaphore=void 0;var ko=Se(),$r=class{constructor(e=1){if(e<=0)throw new Error("Capacity must be greater than 0");this._capacity=e,this._active=0,this._waiting=[]}lock(e){return new Promise((t,n)=>{this._waiting.push({thunk:e,resolve:t,reject:n}),this.runNext()})}get active(){return this._active}runNext(){this._waiting.length===0||this._active===this._capacity||(0,ko.default)().timer.setImmediate(()=>this.doRunNext())}doRunNext(){if(this._waiting.length===0||this._active===this._capacity)return;let e=this._waiting.shift();if(this._active++,this._active>this._capacity)throw new Error("To many thunks active");try{let t=e.thunk();t instanceof Promise?t.then(n=>{this._active--,e.resolve(n),this.runNext()},n=>{this._active--,e.reject(n),this.runNext()}):(this._active--,e.resolve(t),this.runNext())}catch(t){this._active--,e.reject(t),this.runNext()}}};xt.Semaphore=$r});var us=R(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.ReadableStreamMessageReader=ve.AbstractMessageReader=ve.MessageReader=void 0;var Fr=Se(),Ue=qe(),Ur=Ae(),Ro=Wr(),cs;(function(r){function e(t){let n=t;return n&&Ue.func(n.listen)&&Ue.func(n.dispose)&&Ue.func(n.onError)&&Ue.func(n.onClose)&&Ue.func(n.onPartialMessage)}r.is=e})(cs||(ve.MessageReader=cs={}));var Tt=class{constructor(){this.errorEmitter=new Ur.Emitter,this.closeEmitter=new Ur.Emitter,this.partialMessageEmitter=new Ur.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e){this.errorEmitter.fire(this.asError(e))}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}get onPartialMessage(){return this.partialMessageEmitter.event}firePartialMessage(e){this.partialMessageEmitter.fire(e)}asError(e){return e instanceof Error?e:new Error(`Reader received error. Reason: ${Ue.string(e.message)?e.message:"unknown"}`)}};ve.AbstractMessageReader=Tt;var Vr;(function(r){function e(t){let n,s,i,a=new Map,f,h=new Map;if(t===void 0||typeof t=="string")n=t??"utf-8";else{if(n=t.charset??"utf-8",t.contentDecoder!==void 0&&(i=t.contentDecoder,a.set(i.name,i)),t.contentDecoders!==void 0)for(let l of t.contentDecoders)a.set(l.name,l);if(t.contentTypeDecoder!==void 0&&(f=t.contentTypeDecoder,h.set(f.name,f)),t.contentTypeDecoders!==void 0)for(let l of t.contentTypeDecoders)h.set(l.name,l)}return f===void 0&&(f=(0,Fr.default)().applicationJson.decoder,h.set(f.name,f)),{charset:n,contentDecoder:i,contentDecoders:a,contentTypeDecoder:f,contentTypeDecoders:h}}r.fromOptions=e})(Vr||(Vr={}));var Gr=class extends Tt{constructor(e,t){super(),this.readable=e,this.options=Vr.fromOptions(t),this.buffer=(0,Fr.default)().messageBuffer.create(this.options.charset),this._partialMessageTimeout=1e4,this.nextMessageLength=-1,this.messageToken=0,this.readSemaphore=new Ro.Semaphore(1)}set partialMessageTimeout(e){this._partialMessageTimeout=e}get partialMessageTimeout(){return this._partialMessageTimeout}listen(e){this.nextMessageLength=-1,this.messageToken=0,this.partialMessageTimer=void 0,this.callback=e;let t=this.readable.onData(n=>{this.onData(n)});return this.readable.onError(n=>this.fireError(n)),this.readable.onClose(()=>this.fireClose()),t}onData(e){try{for(this.buffer.append(e);;){if(this.nextMessageLength===-1){let n=this.buffer.tryReadHeaders(!0);if(!n)return;let s=n.get("content-length");if(!s){this.fireError(new Error(`Header must provide a Content-Length property.
${JSON.stringify(Object.fromEntries(n))}`));return}let i=parseInt(s);if(isNaN(i)){this.fireError(new Error(`Content-Length value must be a number. Got ${s}`));return}this.nextMessageLength=i}let t=this.buffer.tryReadBody(this.nextMessageLength);if(t===void 0){this.setPartialMessageTimer();return}this.clearPartialMessageTimer(),this.nextMessageLength=-1,this.readSemaphore.lock(async()=>{let n=this.options.contentDecoder!==void 0?await this.options.contentDecoder.decode(t):t,s=await this.options.contentTypeDecoder.decode(n,this.options);this.callback(s)}).catch(n=>{this.fireError(n)})}}catch(t){this.fireError(t)}}clearPartialMessageTimer(){this.partialMessageTimer&&(this.partialMessageTimer.dispose(),this.partialMessageTimer=void 0)}setPartialMessageTimer(){this.clearPartialMessageTimer(),!(this._partialMessageTimeout<=0)&&(this.partialMessageTimer=(0,Fr.default)().timer.setTimeout((e,t)=>{this.partialMessageTimer=void 0,e===this.messageToken&&(this.firePartialMessage({messageToken:e,waitingTime:t}),this.setPartialMessageTimer())},this._partialMessageTimeout,this.messageToken,this._partialMessageTimeout))}};ve.ReadableStreamMessageReader=Gr});var ps=R(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});Ee.WriteableStreamMessageWriter=Ee.AbstractMessageWriter=Ee.MessageWriter=void 0;var ls=Se(),nt=qe(),No=Wr(),fs=Ae(),Lo="Content-Length: ",ds=`\r
`,hs;(function(r){function e(t){let n=t;return n&&nt.func(n.dispose)&&nt.func(n.onClose)&&nt.func(n.onError)&&nt.func(n.write)}r.is=e})(hs||(Ee.MessageWriter=hs={}));var Ot=class{constructor(){this.errorEmitter=new fs.Emitter,this.closeEmitter=new fs.Emitter}dispose(){this.errorEmitter.dispose(),this.closeEmitter.dispose()}get onError(){return this.errorEmitter.event}fireError(e,t,n){this.errorEmitter.fire([this.asError(e),t,n])}get onClose(){return this.closeEmitter.event}fireClose(){this.closeEmitter.fire(void 0)}asError(e){return e instanceof Error?e:new Error(`Writer received error. Reason: ${nt.string(e.message)?e.message:"unknown"}`)}};Ee.AbstractMessageWriter=Ot;var zr;(function(r){function e(t){return t===void 0||typeof t=="string"?{charset:t??"utf-8",contentTypeEncoder:(0,ls.default)().applicationJson.encoder}:{charset:t.charset??"utf-8",contentEncoder:t.contentEncoder,contentTypeEncoder:t.contentTypeEncoder??(0,ls.default)().applicationJson.encoder}}r.fromOptions=e})(zr||(zr={}));var Hr=class extends Ot{constructor(e,t){super(),this.writable=e,this.options=zr.fromOptions(t),this.errorCount=0,this.writeSemaphore=new No.Semaphore(1),this.writable.onError(n=>this.fireError(n)),this.writable.onClose(()=>this.fireClose())}async write(e){return this.writeSemaphore.lock(async()=>this.options.contentTypeEncoder.encode(e,this.options).then(n=>this.options.contentEncoder!==void 0?this.options.contentEncoder.encode(n):n).then(n=>{let s=[];return s.push(Lo,n.byteLength.toString(),ds),s.push(ds),this.doWrite(e,s,n)},n=>{throw this.fireError(n),n}))}async doWrite(e,t,n){try{return await this.writable.write(t.join(""),"ascii"),this.writable.write(n)}catch(s){return this.handleError(s,e),Promise.reject(s)}}handleError(e,t){this.errorCount++,this.fireError(e,t,this.errorCount)}end(){this.writable.end()}};Ee.WriteableStreamMessageWriter=Hr});var ms=R(Ct=>{"use strict";Object.defineProperty(Ct,"__esModule",{value:!0});Ct.AbstractMessageBuffer=void 0;var Mo=13,jo=10,Io=`\r
`,Jr=class{constructor(e="utf-8"){this._encoding=e,this._chunks=[],this._totalLength=0}get encoding(){return this._encoding}append(e){let t=typeof e=="string"?this.fromString(e,this._encoding):e;this._chunks.push(t),this._totalLength+=t.byteLength}tryReadHeaders(e=!1){if(this._chunks.length===0)return;let t=0,n=0,s=0,i=0;e:for(;n<this._chunks.length;){let l=this._chunks[n];for(s=0;s<l.length;){switch(l[s]){case Mo:switch(t){case 0:t=1;break;case 2:t=3;break;default:t=0}break;case jo:switch(t){case 1:t=2;break;case 3:t=4,s++;break e;default:t=0}break;default:t=0}s++}i+=l.byteLength,n++}if(t!==4)return;let a=this._read(i+s),f=new Map,h=this.toString(a,"ascii").split(Io);if(h.length<2)return f;for(let l=0;l<h.length-2;l++){let g=h[l],p=g.indexOf(":");if(p===-1)throw new Error(`Message header must separate key and value using ':'
${g}`);let m=g.substr(0,p),S=g.substr(p+1).trim();f.set(e?m.toLowerCase():m,S)}return f}tryReadBody(e){if(!(this._totalLength<e))return this._read(e)}get numberOfBytes(){return this._totalLength}_read(e){if(e===0)return this.emptyBuffer();if(e>this._totalLength)throw new Error("Cannot read so many bytes!");if(this._chunks[0].byteLength===e){let i=this._chunks[0];return this._chunks.shift(),this._totalLength-=e,this.asNative(i)}if(this._chunks[0].byteLength>e){let i=this._chunks[0],a=this.asNative(i,e);return this._chunks[0]=i.slice(e),this._totalLength-=e,a}let t=this.allocNative(e),n=0,s=0;for(;e>0;){let i=this._chunks[s];if(i.byteLength>e){let a=i.slice(0,e);t.set(a,n),n+=e,this._chunks[s]=i.slice(e),this._totalLength-=e,e-=e}else t.set(i,n),n+=i.byteLength,this._chunks.shift(),this._totalLength-=i.byteLength,e-=i.byteLength}return t}};Ct.AbstractMessageBuffer=Jr});var Ss=R(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.createMessageConnection=T.ConnectionOptions=T.MessageStrategy=T.CancellationStrategy=T.CancellationSenderStrategy=T.CancellationReceiverStrategy=T.RequestCancellationReceiverStrategy=T.IdCancellationReceiverStrategy=T.ConnectionStrategy=T.ConnectionError=T.ConnectionErrors=T.LogTraceNotification=T.SetTraceNotification=T.TraceFormat=T.TraceValues=T.Trace=T.NullLogger=T.ProgressType=T.ProgressToken=void 0;var _s=Se(),U=qe(),v=Cr(),gs=kr(),st=Ae(),Yr=wt(),at;(function(r){r.type=new v.NotificationType("$/cancelRequest")})(at||(at={}));var Kr;(function(r){function e(t){return typeof t=="string"||typeof t=="number"}r.is=e})(Kr||(T.ProgressToken=Kr={}));var it;(function(r){r.type=new v.NotificationType("$/progress")})(it||(it={}));var Xr=class{constructor(){}};T.ProgressType=Xr;var Qr;(function(r){function e(t){return U.func(t)}r.is=e})(Qr||(Qr={}));T.NullLogger=Object.freeze({error:()=>{},warn:()=>{},info:()=>{},log:()=>{}});var N;(function(r){r[r.Off=0]="Off",r[r.Messages=1]="Messages",r[r.Compact=2]="Compact",r[r.Verbose=3]="Verbose"})(N||(T.Trace=N={}));var ys;(function(r){r.Off="off",r.Messages="messages",r.Compact="compact",r.Verbose="verbose"})(ys||(T.TraceValues=ys={}));(function(r){function e(n){if(!U.string(n))return r.Off;switch(n=n.toLowerCase(),n){case"off":return r.Off;case"messages":return r.Messages;case"compact":return r.Compact;case"verbose":return r.Verbose;default:return r.Off}}r.fromString=e;function t(n){switch(n){case r.Off:return"off";case r.Messages:return"messages";case r.Compact:return"compact";case r.Verbose:return"verbose";default:return"off"}}r.toString=t})(N||(T.Trace=N={}));var re;(function(r){r.Text="text",r.JSON="json"})(re||(T.TraceFormat=re={}));(function(r){function e(t){return U.string(t)?(t=t.toLowerCase(),t==="json"?r.JSON:r.Text):r.Text}r.fromString=e})(re||(T.TraceFormat=re={}));var Zr;(function(r){r.type=new v.NotificationType("$/setTrace")})(Zr||(T.SetTraceNotification=Zr={}));var Pt;(function(r){r.type=new v.NotificationType("$/logTrace")})(Pt||(T.LogTraceNotification=Pt={}));var ot;(function(r){r[r.Closed=1]="Closed",r[r.Disposed=2]="Disposed",r[r.AlreadyListening=3]="AlreadyListening"})(ot||(T.ConnectionErrors=ot={}));var Fe=class r extends Error{constructor(e,t){super(t),this.code=e,Object.setPrototypeOf(this,r.prototype)}};T.ConnectionError=Fe;var en;(function(r){function e(t){let n=t;return n&&U.func(n.cancelUndispatched)}r.is=e})(en||(T.ConnectionStrategy=en={}));var kt;(function(r){function e(t){let n=t;return n&&(n.kind===void 0||n.kind==="id")&&U.func(n.createCancellationTokenSource)&&(n.dispose===void 0||U.func(n.dispose))}r.is=e})(kt||(T.IdCancellationReceiverStrategy=kt={}));var tn;(function(r){function e(t){let n=t;return n&&n.kind==="request"&&U.func(n.createCancellationTokenSource)&&(n.dispose===void 0||U.func(n.dispose))}r.is=e})(tn||(T.RequestCancellationReceiverStrategy=tn={}));var Rt;(function(r){r.Message=Object.freeze({createCancellationTokenSource(t){return new Yr.CancellationTokenSource}});function e(t){return kt.is(t)||tn.is(t)}r.is=e})(Rt||(T.CancellationReceiverStrategy=Rt={}));var Nt;(function(r){r.Message=Object.freeze({sendCancellation(t,n){return t.sendNotification(at.type,{id:n})},cleanup(t){}});function e(t){let n=t;return n&&U.func(n.sendCancellation)&&U.func(n.cleanup)}r.is=e})(Nt||(T.CancellationSenderStrategy=Nt={}));var Lt;(function(r){r.Message=Object.freeze({receiver:Rt.Message,sender:Nt.Message});function e(t){let n=t;return n&&Rt.is(n.receiver)&&Nt.is(n.sender)}r.is=e})(Lt||(T.CancellationStrategy=Lt={}));var Mt;(function(r){function e(t){let n=t;return n&&U.func(n.handleMessage)}r.is=e})(Mt||(T.MessageStrategy=Mt={}));var bs;(function(r){function e(t){let n=t;return n&&(Lt.is(n.cancellationStrategy)||en.is(n.connectionStrategy)||Mt.is(n.messageStrategy))}r.is=e})(bs||(T.ConnectionOptions=bs={}));var ce;(function(r){r[r.New=1]="New",r[r.Listening=2]="Listening",r[r.Closed=3]="Closed",r[r.Disposed=4]="Disposed"})(ce||(ce={}));function Do(r,e,t,n){let s=t!==void 0?t:T.NullLogger,i=0,a=0,f=0,h="2.0",l,g=new Map,p,m=new Map,S=new Map,O,w=new gs.LinkedMap,L=new Map,$=new Set,G=new Map,x=N.Off,b=re.Text,E,F=ce.New,C=new st.Emitter,ae=new st.Emitter,J=new st.Emitter,Z=new st.Emitter,An=new st.Emitter,ge=n&&n.cancellationStrategy?n.cancellationStrategy:Lt.Message;function $n(o){if(o===null)throw new Error("Can't send requests with id null since the response can't be correlated.");return"req-"+o.toString()}function Gi(o){return o===null?"res-unknown-"+(++f).toString():"res-"+o.toString()}function zi(){return"not-"+(++a).toString()}function Hi(o,u){v.Message.isRequest(u)?o.set($n(u.id),u):v.Message.isResponse(u)?o.set(Gi(u.id),u):o.set(zi(),u)}function Ji(o){}function Wn(){return F===ce.Listening}function Un(){return F===ce.Closed}function je(){return F===ce.Disposed}function Fn(){(F===ce.New||F===ce.Listening)&&(F=ce.Closed,ae.fire(void 0))}function Yi(o){C.fire([o,void 0,void 0])}function Ki(o){C.fire(o)}r.onClose(Fn),r.onError(Yi),e.onClose(Fn),e.onError(Ki);function Vn(){O||w.size===0||(O=(0,_s.default)().timer.setImmediate(()=>{O=void 0,Xi()}))}function Gn(o){v.Message.isRequest(o)?Zi(o):v.Message.isNotification(o)?to(o):v.Message.isResponse(o)?eo(o):ro(o)}function Xi(){if(w.size===0)return;let o=w.shift();try{let u=n==null?void 0:n.messageStrategy;Mt.is(u)?u.handleMessage(o,Gn):Gn(o)}finally{Vn()}}let Qi=o=>{try{if(v.Message.isNotification(o)&&o.method===at.type.method){let u=o.params.id,d=$n(u),_=w.get(d);if(v.Message.isRequest(_)){let j=n==null?void 0:n.connectionStrategy,I=j&&j.cancelUndispatched?j.cancelUndispatched(_,Ji):void 0;if(I&&(I.error!==void 0||I.result!==void 0)){w.delete(d),G.delete(u),I.id=_.id,_t(I,o.method,Date.now()),e.write(I).catch(()=>s.error("Sending response for canceled message failed."));return}}let q=G.get(u);if(q!==void 0){q.cancel(),tr(o);return}else $.add(u)}Hi(w,o)}finally{Vn()}};function Zi(o){if(je())return;function u(k,W,M){let z={jsonrpc:h,id:o.id};k instanceof v.ResponseError?z.error=k.toJson():z.result=k===void 0?null:k,_t(z,W,M),e.write(z).catch(()=>s.error("Sending response failed."))}function d(k,W,M){let z={jsonrpc:h,id:o.id,error:k.toJson()};_t(z,W,M),e.write(z).catch(()=>s.error("Sending response failed."))}function _(k,W,M){k===void 0&&(k=null);let z={jsonrpc:h,id:o.id,result:k};_t(z,W,M),e.write(z).catch(()=>s.error("Sending response failed."))}io(o);let q=g.get(o.method),j,I;q&&(j=q.type,I=q.handler);let V=Date.now();if(I||l){let k=o.id??String(Date.now()),W=kt.is(ge.receiver)?ge.receiver.createCancellationTokenSource(k):ge.receiver.createCancellationTokenSource(o);o.id!==null&&$.has(o.id)&&W.cancel(),o.id!==null&&G.set(k,W);try{let M;if(I)if(o.params===void 0){if(j!==void 0&&j.numberOfParams!==0){d(new v.ResponseError(v.ErrorCodes.InvalidParams,`Request ${o.method} defines ${j.numberOfParams} params but received none.`),o.method,V);return}M=I(W.token)}else if(Array.isArray(o.params)){if(j!==void 0&&j.parameterStructures===v.ParameterStructures.byName){d(new v.ResponseError(v.ErrorCodes.InvalidParams,`Request ${o.method} defines parameters by name but received parameters by position`),o.method,V);return}M=I(...o.params,W.token)}else{if(j!==void 0&&j.parameterStructures===v.ParameterStructures.byPosition){d(new v.ResponseError(v.ErrorCodes.InvalidParams,`Request ${o.method} defines parameters by position but received parameters by name`),o.method,V);return}M=I(o.params,W.token)}else l&&(M=l(o.method,o.params,W.token));let z=M;M?z.then?z.then(Q=>{G.delete(k),u(Q,o.method,V)},Q=>{G.delete(k),Q instanceof v.ResponseError?d(Q,o.method,V):Q&&U.string(Q.message)?d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed with message: ${Q.message}`),o.method,V):d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed unexpectedly without providing any details.`),o.method,V)}):(G.delete(k),u(M,o.method,V)):(G.delete(k),_(M,o.method,V))}catch(M){G.delete(k),M instanceof v.ResponseError?u(M,o.method,V):M&&U.string(M.message)?d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed with message: ${M.message}`),o.method,V):d(new v.ResponseError(v.ErrorCodes.InternalError,`Request ${o.method} failed unexpectedly without providing any details.`),o.method,V)}}else d(new v.ResponseError(v.ErrorCodes.MethodNotFound,`Unhandled method ${o.method}`),o.method,V)}function eo(o){if(!je())if(o.id===null)o.error?s.error(`Received response message without id: Error is: 
${JSON.stringify(o.error,void 0,4)}`):s.error("Received response message without id. No further error information provided.");else{let u=o.id,d=L.get(u);if(oo(o,d),d!==void 0){L.delete(u);try{if(o.error){let _=o.error;d.reject(new v.ResponseError(_.code,_.message,_.data))}else if(o.result!==void 0)d.resolve(o.result);else throw new Error("Should never happen.")}catch(_){_.message?s.error(`Response handler '${d.method}' failed with message: ${_.message}`):s.error(`Response handler '${d.method}' failed unexpectedly.`)}}}}function to(o){if(je())return;let u,d;if(o.method===at.type.method){let _=o.params.id;$.delete(_),tr(o);return}else{let _=m.get(o.method);_&&(d=_.handler,u=_.type)}if(d||p)try{if(tr(o),d)if(o.params===void 0)u!==void 0&&u.numberOfParams!==0&&u.parameterStructures!==v.ParameterStructures.byName&&s.error(`Notification ${o.method} defines ${u.numberOfParams} params but received none.`),d();else if(Array.isArray(o.params)){let _=o.params;o.method===it.type.method&&_.length===2&&Kr.is(_[0])?d({token:_[0],value:_[1]}):(u!==void 0&&(u.parameterStructures===v.ParameterStructures.byName&&s.error(`Notification ${o.method} defines parameters by name but received parameters by position`),u.numberOfParams!==o.params.length&&s.error(`Notification ${o.method} defines ${u.numberOfParams} params but received ${_.length} arguments`)),d(..._))}else u!==void 0&&u.parameterStructures===v.ParameterStructures.byPosition&&s.error(`Notification ${o.method} defines parameters by position but received parameters by name`),d(o.params);else p&&p(o.method,o.params)}catch(_){_.message?s.error(`Notification handler '${o.method}' failed with message: ${_.message}`):s.error(`Notification handler '${o.method}' failed unexpectedly.`)}else J.fire(o)}function ro(o){if(!o){s.error("Received empty message.");return}s.error(`Received message which is neither a response nor a notification message:
${JSON.stringify(o,null,4)}`);let u=o;if(U.string(u.id)||U.number(u.id)){let d=u.id,_=L.get(d);_&&_.reject(new Error("The received response has neither a result nor an error property."))}}function ye(o){if(o!=null)switch(x){case N.Verbose:return JSON.stringify(o,null,4);case N.Compact:return JSON.stringify(o);default:return}}function no(o){if(!(x===N.Off||!E))if(b===re.Text){let u;(x===N.Verbose||x===N.Compact)&&o.params&&(u=`Params: ${ye(o.params)}

`),E.log(`Sending request '${o.method} - (${o.id})'.`,u)}else Ie("send-request",o)}function so(o){if(!(x===N.Off||!E))if(b===re.Text){let u;(x===N.Verbose||x===N.Compact)&&(o.params?u=`Params: ${ye(o.params)}

`:u=`No parameters provided.

`),E.log(`Sending notification '${o.method}'.`,u)}else Ie("send-notification",o)}function _t(o,u,d){if(!(x===N.Off||!E))if(b===re.Text){let _;(x===N.Verbose||x===N.Compact)&&(o.error&&o.error.data?_=`Error data: ${ye(o.error.data)}

`:o.result?_=`Result: ${ye(o.result)}

`:o.error===void 0&&(_=`No result returned.

`)),E.log(`Sending response '${u} - (${o.id})'. Processing request took ${Date.now()-d}ms`,_)}else Ie("send-response",o)}function io(o){if(!(x===N.Off||!E))if(b===re.Text){let u;(x===N.Verbose||x===N.Compact)&&o.params&&(u=`Params: ${ye(o.params)}

`),E.log(`Received request '${o.method} - (${o.id})'.`,u)}else Ie("receive-request",o)}function tr(o){if(!(x===N.Off||!E||o.method===Pt.type.method))if(b===re.Text){let u;(x===N.Verbose||x===N.Compact)&&(o.params?u=`Params: ${ye(o.params)}

`:u=`No parameters provided.

`),E.log(`Received notification '${o.method}'.`,u)}else Ie("receive-notification",o)}function oo(o,u){if(!(x===N.Off||!E))if(b===re.Text){let d;if((x===N.Verbose||x===N.Compact)&&(o.error&&o.error.data?d=`Error data: ${ye(o.error.data)}

`:o.result?d=`Result: ${ye(o.result)}

`:o.error===void 0&&(d=`No result returned.

`)),u){let _=o.error?` Request failed: ${o.error.message} (${o.error.code}).`:"";E.log(`Received response '${u.method} - (${o.id})' in ${Date.now()-u.timerStart}ms.${_}`,d)}else E.log(`Received response ${o.id} without active response promise.`,d)}else Ie("receive-response",o)}function Ie(o,u){if(!E||x===N.Off)return;let d={isLSPMessage:!0,type:o,message:u,timestamp:Date.now()};E.log(d)}function et(){if(Un())throw new Fe(ot.Closed,"Connection is closed.");if(je())throw new Fe(ot.Disposed,"Connection is disposed.")}function ao(){if(Wn())throw new Fe(ot.AlreadyListening,"Connection is already listening")}function co(){if(!Wn())throw new Error("Call listen() first.")}function tt(o){return o===void 0?null:o}function zn(o){if(o!==null)return o}function Hn(o){return o!=null&&!Array.isArray(o)&&typeof o=="object"}function rr(o,u){switch(o){case v.ParameterStructures.auto:return Hn(u)?zn(u):[tt(u)];case v.ParameterStructures.byName:if(!Hn(u))throw new Error("Received parameters by name but param is not an object literal.");return zn(u);case v.ParameterStructures.byPosition:return[tt(u)];default:throw new Error(`Unknown parameter structure ${o.toString()}`)}}function Jn(o,u){let d,_=o.numberOfParams;switch(_){case 0:d=void 0;break;case 1:d=rr(o.parameterStructures,u[0]);break;default:d=[];for(let q=0;q<u.length&&q<_;q++)d.push(tt(u[q]));if(u.length<_)for(let q=u.length;q<_;q++)d.push(null);break}return d}let De={sendNotification:(o,...u)=>{et();let d,_;if(U.string(o)){d=o;let j=u[0],I=0,V=v.ParameterStructures.auto;v.ParameterStructures.is(j)&&(I=1,V=j);let k=u.length,W=k-I;switch(W){case 0:_=void 0;break;case 1:_=rr(V,u[I]);break;default:if(V===v.ParameterStructures.byName)throw new Error(`Received ${W} parameters for 'by Name' notification parameter structure.`);_=u.slice(I,k).map(M=>tt(M));break}}else{let j=u;d=o.method,_=Jn(o,j)}let q={jsonrpc:h,method:d,params:_};return so(q),e.write(q).catch(j=>{throw s.error("Sending notification failed."),j})},onNotification:(o,u)=>{et();let d;return U.func(o)?p=o:u&&(U.string(o)?(d=o,m.set(o,{type:void 0,handler:u})):(d=o.method,m.set(o.method,{type:o,handler:u}))),{dispose:()=>{d!==void 0?m.delete(d):p=void 0}}},onProgress:(o,u,d)=>{if(S.has(u))throw new Error(`Progress handler for token ${u} already registered`);return S.set(u,d),{dispose:()=>{S.delete(u)}}},sendProgress:(o,u,d)=>De.sendNotification(it.type,{token:u,value:d}),onUnhandledProgress:Z.event,sendRequest:(o,...u)=>{et(),co();let d,_,q;if(U.string(o)){d=o;let k=u[0],W=u[u.length-1],M=0,z=v.ParameterStructures.auto;v.ParameterStructures.is(k)&&(M=1,z=k);let Q=u.length;Yr.CancellationToken.is(W)&&(Q=Q-1,q=W);let le=Q-M;switch(le){case 0:_=void 0;break;case 1:_=rr(z,u[M]);break;default:if(z===v.ParameterStructures.byName)throw new Error(`Received ${le} parameters for 'by Name' request parameter structure.`);_=u.slice(M,Q).map(uo=>tt(uo));break}}else{let k=u;d=o.method,_=Jn(o,k);let W=o.numberOfParams;q=Yr.CancellationToken.is(k[W])?k[W]:void 0}let j=i++,I;q&&(I=q.onCancellationRequested(()=>{let k=ge.sender.sendCancellation(De,j);return k===void 0?(s.log(`Received no promise from cancellation strategy when cancelling id ${j}`),Promise.resolve()):k.catch(()=>{s.log(`Sending cancellation messages for id ${j} failed`)})}));let V={jsonrpc:h,id:j,method:d,params:_};return no(V),typeof ge.sender.enableCancellation=="function"&&ge.sender.enableCancellation(V),new Promise(async(k,W)=>{let M=le=>{k(le),ge.sender.cleanup(j),I==null||I.dispose()},z=le=>{W(le),ge.sender.cleanup(j),I==null||I.dispose()},Q={method:d,timerStart:Date.now(),resolve:M,reject:z};try{L.set(j,Q),await e.write(V)}catch(le){throw L.delete(j),Q.reject(new v.ResponseError(v.ErrorCodes.MessageWriteError,le.message?le.message:"Unknown reason")),s.error("Sending request failed."),le}})},onRequest:(o,u)=>{et();let d=null;return Qr.is(o)?(d=void 0,l=o):U.string(o)?(d=null,u!==void 0&&(d=o,g.set(o,{handler:u,type:void 0}))):u!==void 0&&(d=o.method,g.set(o.method,{type:o,handler:u})),{dispose:()=>{d!==null&&(d!==void 0?g.delete(d):l=void 0)}}},hasPendingResponse:()=>L.size>0,trace:async(o,u,d)=>{let _=!1,q=re.Text;d!==void 0&&(U.boolean(d)?_=d:(_=d.sendNotification||!1,q=d.traceFormat||re.Text)),x=o,b=q,x===N.Off?E=void 0:E=u,_&&!Un()&&!je()&&await De.sendNotification(Zr.type,{value:N.toString(o)})},onError:C.event,onClose:ae.event,onUnhandledNotification:J.event,onDispose:An.event,end:()=>{e.end()},dispose:()=>{if(je())return;F=ce.Disposed,An.fire(void 0);let o=new v.ResponseError(v.ErrorCodes.PendingResponseRejected,"Pending response rejected since connection got disposed");for(let u of L.values())u.reject(o);L=new Map,G=new Map,$=new Set,w=new gs.LinkedMap,U.func(e.dispose)&&e.dispose(),U.func(r.dispose)&&r.dispose()},listen:()=>{et(),ao(),F=ce.Listening,r.listen(Qi)},inspect:()=>{(0,_s.default)().console.log("inspect")}};return De.onNotification(Pt.type,o=>{if(x===N.Off||!E)return;let u=x===N.Verbose||x===N.Compact;E.log(o.message,u?o.verbose:void 0)}),De.onNotification(it.type,o=>{let u=S.get(o.token);u?u(o.value):Z.fire(o)}),De}T.createMessageConnection=Do});var jt=R(c=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0});c.ProgressType=c.ProgressToken=c.createMessageConnection=c.NullLogger=c.ConnectionOptions=c.ConnectionStrategy=c.AbstractMessageBuffer=c.WriteableStreamMessageWriter=c.AbstractMessageWriter=c.MessageWriter=c.ReadableStreamMessageReader=c.AbstractMessageReader=c.MessageReader=c.SharedArrayReceiverStrategy=c.SharedArraySenderStrategy=c.CancellationToken=c.CancellationTokenSource=c.Emitter=c.Event=c.Disposable=c.LRUCache=c.Touch=c.LinkedMap=c.ParameterStructures=c.NotificationType9=c.NotificationType8=c.NotificationType7=c.NotificationType6=c.NotificationType5=c.NotificationType4=c.NotificationType3=c.NotificationType2=c.NotificationType1=c.NotificationType0=c.NotificationType=c.ErrorCodes=c.ResponseError=c.RequestType9=c.RequestType8=c.RequestType7=c.RequestType6=c.RequestType5=c.RequestType4=c.RequestType3=c.RequestType2=c.RequestType1=c.RequestType0=c.RequestType=c.Message=c.RAL=void 0;c.MessageStrategy=c.CancellationStrategy=c.CancellationSenderStrategy=c.CancellationReceiverStrategy=c.ConnectionError=c.ConnectionErrors=c.LogTraceNotification=c.SetTraceNotification=c.TraceFormat=c.TraceValues=c.Trace=void 0;var D=Cr();Object.defineProperty(c,"Message",{enumerable:!0,get:function(){return D.Message}});Object.defineProperty(c,"RequestType",{enumerable:!0,get:function(){return D.RequestType}});Object.defineProperty(c,"RequestType0",{enumerable:!0,get:function(){return D.RequestType0}});Object.defineProperty(c,"RequestType1",{enumerable:!0,get:function(){return D.RequestType1}});Object.defineProperty(c,"RequestType2",{enumerable:!0,get:function(){return D.RequestType2}});Object.defineProperty(c,"RequestType3",{enumerable:!0,get:function(){return D.RequestType3}});Object.defineProperty(c,"RequestType4",{enumerable:!0,get:function(){return D.RequestType4}});Object.defineProperty(c,"RequestType5",{enumerable:!0,get:function(){return D.RequestType5}});Object.defineProperty(c,"RequestType6",{enumerable:!0,get:function(){return D.RequestType6}});Object.defineProperty(c,"RequestType7",{enumerable:!0,get:function(){return D.RequestType7}});Object.defineProperty(c,"RequestType8",{enumerable:!0,get:function(){return D.RequestType8}});Object.defineProperty(c,"RequestType9",{enumerable:!0,get:function(){return D.RequestType9}});Object.defineProperty(c,"ResponseError",{enumerable:!0,get:function(){return D.ResponseError}});Object.defineProperty(c,"ErrorCodes",{enumerable:!0,get:function(){return D.ErrorCodes}});Object.defineProperty(c,"NotificationType",{enumerable:!0,get:function(){return D.NotificationType}});Object.defineProperty(c,"NotificationType0",{enumerable:!0,get:function(){return D.NotificationType0}});Object.defineProperty(c,"NotificationType1",{enumerable:!0,get:function(){return D.NotificationType1}});Object.defineProperty(c,"NotificationType2",{enumerable:!0,get:function(){return D.NotificationType2}});Object.defineProperty(c,"NotificationType3",{enumerable:!0,get:function(){return D.NotificationType3}});Object.defineProperty(c,"NotificationType4",{enumerable:!0,get:function(){return D.NotificationType4}});Object.defineProperty(c,"NotificationType5",{enumerable:!0,get:function(){return D.NotificationType5}});Object.defineProperty(c,"NotificationType6",{enumerable:!0,get:function(){return D.NotificationType6}});Object.defineProperty(c,"NotificationType7",{enumerable:!0,get:function(){return D.NotificationType7}});Object.defineProperty(c,"NotificationType8",{enumerable:!0,get:function(){return D.NotificationType8}});Object.defineProperty(c,"NotificationType9",{enumerable:!0,get:function(){return D.NotificationType9}});Object.defineProperty(c,"ParameterStructures",{enumerable:!0,get:function(){return D.ParameterStructures}});var rn=kr();Object.defineProperty(c,"LinkedMap",{enumerable:!0,get:function(){return rn.LinkedMap}});Object.defineProperty(c,"LRUCache",{enumerable:!0,get:function(){return rn.LRUCache}});Object.defineProperty(c,"Touch",{enumerable:!0,get:function(){return rn.Touch}});var qo=is();Object.defineProperty(c,"Disposable",{enumerable:!0,get:function(){return qo.Disposable}});var vs=Ae();Object.defineProperty(c,"Event",{enumerable:!0,get:function(){return vs.Event}});Object.defineProperty(c,"Emitter",{enumerable:!0,get:function(){return vs.Emitter}});var Es=wt();Object.defineProperty(c,"CancellationTokenSource",{enumerable:!0,get:function(){return Es.CancellationTokenSource}});Object.defineProperty(c,"CancellationToken",{enumerable:!0,get:function(){return Es.CancellationToken}});var ws=as();Object.defineProperty(c,"SharedArraySenderStrategy",{enumerable:!0,get:function(){return ws.SharedArraySenderStrategy}});Object.defineProperty(c,"SharedArrayReceiverStrategy",{enumerable:!0,get:function(){return ws.SharedArrayReceiverStrategy}});var nn=us();Object.defineProperty(c,"MessageReader",{enumerable:!0,get:function(){return nn.MessageReader}});Object.defineProperty(c,"AbstractMessageReader",{enumerable:!0,get:function(){return nn.AbstractMessageReader}});Object.defineProperty(c,"ReadableStreamMessageReader",{enumerable:!0,get:function(){return nn.ReadableStreamMessageReader}});var sn=ps();Object.defineProperty(c,"MessageWriter",{enumerable:!0,get:function(){return sn.MessageWriter}});Object.defineProperty(c,"AbstractMessageWriter",{enumerable:!0,get:function(){return sn.AbstractMessageWriter}});Object.defineProperty(c,"WriteableStreamMessageWriter",{enumerable:!0,get:function(){return sn.WriteableStreamMessageWriter}});var Bo=ms();Object.defineProperty(c,"AbstractMessageBuffer",{enumerable:!0,get:function(){return Bo.AbstractMessageBuffer}});var Y=Ss();Object.defineProperty(c,"ConnectionStrategy",{enumerable:!0,get:function(){return Y.ConnectionStrategy}});Object.defineProperty(c,"ConnectionOptions",{enumerable:!0,get:function(){return Y.ConnectionOptions}});Object.defineProperty(c,"NullLogger",{enumerable:!0,get:function(){return Y.NullLogger}});Object.defineProperty(c,"createMessageConnection",{enumerable:!0,get:function(){return Y.createMessageConnection}});Object.defineProperty(c,"ProgressToken",{enumerable:!0,get:function(){return Y.ProgressToken}});Object.defineProperty(c,"ProgressType",{enumerable:!0,get:function(){return Y.ProgressType}});Object.defineProperty(c,"Trace",{enumerable:!0,get:function(){return Y.Trace}});Object.defineProperty(c,"TraceValues",{enumerable:!0,get:function(){return Y.TraceValues}});Object.defineProperty(c,"TraceFormat",{enumerable:!0,get:function(){return Y.TraceFormat}});Object.defineProperty(c,"SetTraceNotification",{enumerable:!0,get:function(){return Y.SetTraceNotification}});Object.defineProperty(c,"LogTraceNotification",{enumerable:!0,get:function(){return Y.LogTraceNotification}});Object.defineProperty(c,"ConnectionErrors",{enumerable:!0,get:function(){return Y.ConnectionErrors}});Object.defineProperty(c,"ConnectionError",{enumerable:!0,get:function(){return Y.ConnectionError}});Object.defineProperty(c,"CancellationReceiverStrategy",{enumerable:!0,get:function(){return Y.CancellationReceiverStrategy}});Object.defineProperty(c,"CancellationSenderStrategy",{enumerable:!0,get:function(){return Y.CancellationSenderStrategy}});Object.defineProperty(c,"CancellationStrategy",{enumerable:!0,get:function(){return Y.CancellationStrategy}});Object.defineProperty(c,"MessageStrategy",{enumerable:!0,get:function(){return Y.MessageStrategy}});var Ao=Se();c.RAL=Ao.default});var Os=R(un=>{"use strict";Object.defineProperty(un,"__esModule",{value:!0});var xs=require("util"),de=jt(),It=class r extends de.AbstractMessageBuffer{constructor(e="utf-8"){super(e)}emptyBuffer(){return r.emptyBuffer}fromString(e,t){return Buffer.from(e,t)}toString(e,t){return e instanceof Buffer?e.toString(t):new xs.TextDecoder(t).decode(e)}asNative(e,t){return t===void 0?e instanceof Buffer?e:Buffer.from(e):e instanceof Buffer?e.slice(0,t):Buffer.from(e,0,t)}allocNative(e){return Buffer.allocUnsafe(e)}};It.emptyBuffer=Buffer.allocUnsafe(0);var on=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),de.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),de.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),de.Disposable.create(()=>this.stream.off("end",e))}onData(e){return this.stream.on("data",e),de.Disposable.create(()=>this.stream.off("data",e))}},an=class{constructor(e){this.stream=e}onClose(e){return this.stream.on("close",e),de.Disposable.create(()=>this.stream.off("close",e))}onError(e){return this.stream.on("error",e),de.Disposable.create(()=>this.stream.off("error",e))}onEnd(e){return this.stream.on("end",e),de.Disposable.create(()=>this.stream.off("end",e))}write(e,t){return new Promise((n,s)=>{let i=a=>{a==null?n():s(a)};typeof e=="string"?this.stream.write(e,t,i):this.stream.write(e,i)})}end(){this.stream.end()}},Ts=Object.freeze({messageBuffer:Object.freeze({create:r=>new It(r)}),applicationJson:Object.freeze({encoder:Object.freeze({name:"application/json",encode:(r,e)=>{try{return Promise.resolve(Buffer.from(JSON.stringify(r,void 0,0),e.charset))}catch(t){return Promise.reject(t)}}}),decoder:Object.freeze({name:"application/json",decode:(r,e)=>{try{return r instanceof Buffer?Promise.resolve(JSON.parse(r.toString(e.charset))):Promise.resolve(JSON.parse(new xs.TextDecoder(e.charset).decode(r)))}catch(t){return Promise.reject(t)}}})}),stream:Object.freeze({asReadableStream:r=>new on(r),asWritableStream:r=>new an(r)}),console,timer:Object.freeze({setTimeout(r,e,...t){let n=setTimeout(r,e,...t);return{dispose:()=>clearTimeout(n)}},setImmediate(r,...e){let t=setImmediate(r,...e);return{dispose:()=>clearImmediate(t)}},setInterval(r,e,...t){let n=setInterval(r,e,...t);return{dispose:()=>clearInterval(n)}}})});function cn(){return Ts}(function(r){function e(){de.RAL.install(Ts)}r.install=e})(cn||(cn={}));un.default=cn});var we=R(P=>{"use strict";var $o=P&&P.__createBinding||(Object.create?(function(r,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,n,s)}):(function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]})),Wo=P&&P.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&$o(e,r,t)};Object.defineProperty(P,"__esModule",{value:!0});P.createMessageConnection=P.createServerSocketTransport=P.createClientSocketTransport=P.createServerPipeTransport=P.createClientPipeTransport=P.generateRandomPipeName=P.StreamMessageWriter=P.StreamMessageReader=P.SocketMessageWriter=P.SocketMessageReader=P.PortMessageWriter=P.PortMessageReader=P.IPCMessageWriter=P.IPCMessageReader=void 0;var Ve=Os();Ve.default.install();var Cs=require("path"),Uo=require("os"),Fo=require("crypto"),Bt=require("net"),ne=jt();Wo(jt(),P);var ln=class extends ne.AbstractMessageReader{constructor(e){super(),this.process=e;let t=this.process;t.on("error",n=>this.fireError(n)),t.on("close",()=>this.fireClose())}listen(e){return this.process.on("message",e),ne.Disposable.create(()=>this.process.off("message",e))}};P.IPCMessageReader=ln;var fn=class extends ne.AbstractMessageWriter{constructor(e){super(),this.process=e,this.errorCount=0;let t=this.process;t.on("error",n=>this.fireError(n)),t.on("close",()=>this.fireClose)}write(e){try{return typeof this.process.send=="function"&&this.process.send(e,void 0,void 0,t=>{t?(this.errorCount++,this.handleError(t,e)):this.errorCount=0}),Promise.resolve()}catch(t){return this.handleError(t,e),Promise.reject(t)}}handleError(e,t){this.errorCount++,this.fireError(e,t,this.errorCount)}end(){}};P.IPCMessageWriter=fn;var dn=class extends ne.AbstractMessageReader{constructor(e){super(),this.onData=new ne.Emitter,e.on("close",()=>this.fireClose),e.on("error",t=>this.fireError(t)),e.on("message",t=>{this.onData.fire(t)})}listen(e){return this.onData.event(e)}};P.PortMessageReader=dn;var hn=class extends ne.AbstractMessageWriter{constructor(e){super(),this.port=e,this.errorCount=0,e.on("close",()=>this.fireClose()),e.on("error",t=>this.fireError(t))}write(e){try{return this.port.postMessage(e),Promise.resolve()}catch(t){return this.handleError(t,e),Promise.reject(t)}}handleError(e,t){this.errorCount++,this.fireError(e,t,this.errorCount)}end(){}};P.PortMessageWriter=hn;var Ce=class extends ne.ReadableStreamMessageReader{constructor(e,t="utf-8"){super((0,Ve.default)().stream.asReadableStream(e),t)}};P.SocketMessageReader=Ce;var Pe=class extends ne.WriteableStreamMessageWriter{constructor(e,t){super((0,Ve.default)().stream.asWritableStream(e),t),this.socket=e}dispose(){super.dispose(),this.socket.destroy()}};P.SocketMessageWriter=Pe;var Dt=class extends ne.ReadableStreamMessageReader{constructor(e,t){super((0,Ve.default)().stream.asReadableStream(e),t)}};P.StreamMessageReader=Dt;var qt=class extends ne.WriteableStreamMessageWriter{constructor(e,t){super((0,Ve.default)().stream.asWritableStream(e),t)}};P.StreamMessageWriter=qt;var Ps=process.env.XDG_RUNTIME_DIR,Vo=new Map([["linux",107],["darwin",103]]);function Go(){let r=(0,Fo.randomBytes)(21).toString("hex");if(process.platform==="win32")return`\\\\.\\pipe\\vscode-jsonrpc-${r}-sock`;let e;Ps?e=Cs.join(Ps,`vscode-ipc-${r}.sock`):e=Cs.join(Uo.tmpdir(),`vscode-${r}.sock`);let t=Vo.get(process.platform);return t!==void 0&&e.length>t&&(0,Ve.default)().console.warn(`WARNING: IPC handle "${e}" is longer than ${t} characters.`),e}P.generateRandomPipeName=Go;function zo(r,e="utf-8"){let t,n=new Promise((s,i)=>{t=s});return new Promise((s,i)=>{let a=(0,Bt.createServer)(f=>{a.close(),t([new Ce(f,e),new Pe(f,e)])});a.on("error",i),a.listen(r,()=>{a.removeListener("error",i),s({onConnected:()=>n})})})}P.createClientPipeTransport=zo;function Ho(r,e="utf-8"){let t=(0,Bt.createConnection)(r);return[new Ce(t,e),new Pe(t,e)]}P.createServerPipeTransport=Ho;function Jo(r,e="utf-8"){let t,n=new Promise((s,i)=>{t=s});return new Promise((s,i)=>{let a=(0,Bt.createServer)(f=>{a.close(),t([new Ce(f,e),new Pe(f,e)])});a.on("error",i),a.listen(r,"127.0.0.1",()=>{a.removeListener("error",i),s({onConnected:()=>n})})})}P.createClientSocketTransport=Jo;function Yo(r,e="utf-8"){let t=(0,Bt.createConnection)(r,"127.0.0.1");return[new Ce(t,e),new Pe(t,e)]}P.createServerSocketTransport=Yo;function Ko(r){let e=r;return e.read!==void 0&&e.addListener!==void 0}function Xo(r){let e=r;return e.write!==void 0&&e.addListener!==void 0}function Qo(r,e,t,n){t||(t=ne.NullLogger);let s=Ko(r)?new Dt(r):r,i=Xo(e)?new qt(e):e;return ne.ConnectionStrategy.is(n)&&(n={connectionStrategy:n}),(0,ne.createMessageConnection)(s,i,t,n)}P.createMessageConnection=Qo});var Ls=R((Zc,Ns)=>{"use strict";Ns.exports=we()});var he=R((gu,$s)=>{"use strict";var Bs=["nodebuffer","arraybuffer","fragments"],As=typeof Blob<"u";As&&Bs.push("blob");$s.exports={BINARY_TYPES:Bs,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:As,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var ct=R((yu,Ut)=>{"use strict";var{EMPTY_BUFFER:ta}=he(),mn=Buffer[Symbol.species];function ra(r,e){if(r.length===0)return ta;if(r.length===1)return r[0];let t=Buffer.allocUnsafe(e),n=0;for(let s=0;s<r.length;s++){let i=r[s];t.set(i,n),n+=i.length}return n<e?new mn(t.buffer,t.byteOffset,n):t}function Ws(r,e,t,n,s){for(let i=0;i<s;i++)t[n+i]=r[i]^e[i&3]}function Us(r,e){for(let t=0;t<r.length;t++)r[t]^=e[t&3]}function na(r){return r.length===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.length)}function _n(r){if(_n.readOnly=!0,Buffer.isBuffer(r))return r;let e;return r instanceof ArrayBuffer?e=new mn(r):ArrayBuffer.isView(r)?e=new mn(r.buffer,r.byteOffset,r.byteLength):(e=Buffer.from(r),_n.readOnly=!1),e}Ut.exports={concat:ra,mask:Ws,toArrayBuffer:na,toBuffer:_n,unmask:Us};if(!process.env.WS_NO_BUFFER_UTIL)try{let r=require("bufferutil");Ut.exports.mask=function(e,t,n,s,i){i<48?Ws(e,t,n,s,i):r.mask(e,t,n,s,i)},Ut.exports.unmask=function(e,t){e.length<32?Us(e,t):r.unmask(e,t)}}catch{}});var Gs=R((bu,Vs)=>{"use strict";var Fs=Symbol("kDone"),gn=Symbol("kRun"),yn=class{constructor(e){this[Fs]=()=>{this.pending--,this[gn]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[gn]()}[gn](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[Fs])}}};Vs.exports=yn});var lt=R((Su,Ys)=>{"use strict";var ut=require("zlib"),zs=ct(),sa=Gs(),{kStatusCode:Hs}=he(),ia=Buffer[Symbol.species],oa=Buffer.from([0,0,255,255]),Vt=Symbol("permessage-deflate"),pe=Symbol("total-length"),ze=Symbol("callback"),xe=Symbol("buffers"),He=Symbol("error"),Ft,bn=class{constructor(e,t,n){if(this._maxPayload=n|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ft){let s=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Ft=new sa(s)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[ze];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,n=e.find(s=>!(t.serverNoContextTakeover===!1&&s.server_no_context_takeover||s.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>s.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!s.client_max_window_bits));if(!n)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(n.server_no_context_takeover=!0),t.clientNoContextTakeover&&(n.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(n.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?n.client_max_window_bits=t.clientMaxWindowBits:(n.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete n.client_max_window_bits,n}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(n=>{let s=t[n];if(s.length>1)throw new Error(`Parameter "${n}" must have only a single value`);if(s=s[0],n==="client_max_window_bits"){if(s!==!0){let i=+s;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${n}": ${s}`);s=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${n}": ${s}`)}else if(n==="server_max_window_bits"){let i=+s;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${n}": ${s}`);s=i}else if(n==="client_no_context_takeover"||n==="server_no_context_takeover"){if(s!==!0)throw new TypeError(`Invalid value for parameter "${n}": ${s}`)}else throw new Error(`Unknown parameter "${n}"`);t[n]=s})}),e}decompress(e,t,n){Ft.add(s=>{this._decompress(e,t,(i,a)=>{s(),n(i,a)})})}compress(e,t,n){Ft.add(s=>{this._compress(e,t,(i,a)=>{s(),n(i,a)})})}_decompress(e,t,n){let s=this._isServer?"client":"server";if(!this._inflate){let i=`${s}_max_window_bits`,a=typeof this.params[i]!="number"?ut.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=ut.createInflateRaw({...this._options.zlibInflateOptions,windowBits:a}),this._inflate[Vt]=this,this._inflate[pe]=0,this._inflate[xe]=[],this._inflate.on("error",ca),this._inflate.on("data",Js)}this._inflate[ze]=n,this._inflate.write(e),t&&this._inflate.write(oa),this._inflate.flush(()=>{let i=this._inflate[He];if(i){this._inflate.close(),this._inflate=null,n(i);return}let a=zs.concat(this._inflate[xe],this._inflate[pe]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[pe]=0,this._inflate[xe]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),n(null,a)})}_compress(e,t,n){let s=this._isServer?"server":"client";if(!this._deflate){let i=`${s}_max_window_bits`,a=typeof this.params[i]!="number"?ut.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=ut.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:a}),this._deflate[pe]=0,this._deflate[xe]=[],this._deflate.on("data",aa)}this._deflate[ze]=n,this._deflate.write(e),this._deflate.flush(ut.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=zs.concat(this._deflate[xe],this._deflate[pe]);t&&(i=new ia(i.buffer,i.byteOffset,i.length-4)),this._deflate[ze]=null,this._deflate[pe]=0,this._deflate[xe]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),n(null,i)})}};Ys.exports=bn;function aa(r){this[xe].push(r),this[pe]+=r.length}function Js(r){if(this[pe]+=r.length,this[Vt]._maxPayload<1||this[pe]<=this[Vt]._maxPayload){this[xe].push(r);return}this[He]=new RangeError("Max payload size exceeded"),this[He].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[He][Hs]=1009,this.removeListener("data",Js),this.reset()}function ca(r){if(this[Vt]._inflate=null,this[He]){this[ze](this[He]);return}r[Hs]=1007,this[ze](r)}});var Je=R((vu,Gt)=>{"use strict";var{isUtf8:Ks}=require("buffer"),{hasBlob:ua}=he(),la=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function fa(r){return r>=1e3&&r<=1014&&r!==1004&&r!==1005&&r!==1006||r>=3e3&&r<=4999}function Sn(r){let e=r.length,t=0;for(;t<e;)if((r[t]&128)===0)t++;else if((r[t]&224)===192){if(t+1===e||(r[t+1]&192)!==128||(r[t]&254)===192)return!1;t+=2}else if((r[t]&240)===224){if(t+2>=e||(r[t+1]&192)!==128||(r[t+2]&192)!==128||r[t]===224&&(r[t+1]&224)===128||r[t]===237&&(r[t+1]&224)===160)return!1;t+=3}else if((r[t]&248)===240){if(t+3>=e||(r[t+1]&192)!==128||(r[t+2]&192)!==128||(r[t+3]&192)!==128||r[t]===240&&(r[t+1]&240)===128||r[t]===244&&r[t+1]>143||r[t]>244)return!1;t+=4}else return!1;return!0}function da(r){return ua&&typeof r=="object"&&typeof r.arrayBuffer=="function"&&typeof r.type=="string"&&typeof r.stream=="function"&&(r[Symbol.toStringTag]==="Blob"||r[Symbol.toStringTag]==="File")}Gt.exports={isBlob:da,isValidStatusCode:fa,isValidUTF8:Sn,tokenChars:la};if(Ks)Gt.exports.isValidUTF8=function(r){return r.length<24?Sn(r):Ks(r)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let r=require("utf-8-validate");Gt.exports.isValidUTF8=function(e){return e.length<32?Sn(e):r(e)}}catch{}});var Tn=R((Eu,ni)=>{"use strict";var{Writable:ha}=require("stream"),Xs=lt(),{BINARY_TYPES:pa,EMPTY_BUFFER:Qs,kStatusCode:ma,kWebSocket:_a}=he(),{concat:vn,toArrayBuffer:ga,unmask:ya}=ct(),{isValidStatusCode:ba,isValidUTF8:Zs}=Je(),zt=Buffer[Symbol.species],ie=0,ei=1,ti=2,ri=3,En=4,wn=5,Ht=6,xn=class extends ha{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||pa[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[_a]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=ie}_write(e,t,n){if(this._opcode===8&&this._state==ie)return n();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(n)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let n=this._buffers[0];return this._buffers[0]=new zt(n.buffer,n.byteOffset+e,n.length-e),new zt(n.buffer,n.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let n=this._buffers[0],s=t.length-e;e>=n.length?t.set(this._buffers.shift(),s):(t.set(new Uint8Array(n.buffer,n.byteOffset,e),s),this._buffers[0]=new zt(n.buffer,n.byteOffset+e,n.length-e)),e-=n.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case ie:this.getInfo(e);break;case ei:this.getPayloadLength16(e);break;case ti:this.getPayloadLength64(e);break;case ri:this.getMask();break;case En:this.getData(e);break;case wn:case Ht:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if((t[0]&48)!==0){let s=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(s);return}let n=(t[0]&64)===64;if(n&&!this._extensions[Xs.extensionName]){let s=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(s);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(n){let s=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(s);return}if(!this._fragmented){let s=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(s);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let s=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(s);return}this._compressed=n}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let s=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(s);return}if(n){let s=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(s);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let s=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(s);return}}else{let s=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(s);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let s=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(s);return}}else if(this._masked){let s=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(s);return}this._payloadLength===126?this._state=ei:this._payloadLength===127?this._state=ti:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),n=t.readUInt32BE(0);if(n>Math.pow(2,21)-1){let s=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(s);return}this._payloadLength=n*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=ri:this._state=En}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=En}getData(e){let t=Qs;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])!==0&&ya(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=wn,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[Xs.extensionName].decompress(e,this._fin,(s,i)=>{if(s)return t(s);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let a=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(a);return}this._fragments.push(i)}this.dataMessage(t),this._state===ie&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=ie;return}let t=this._messageLength,n=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let s;this._binaryType==="nodebuffer"?s=vn(n,t):this._binaryType==="arraybuffer"?s=ga(vn(n,t)):this._binaryType==="blob"?s=new Blob(n):s=n,this._allowSynchronousEvents?(this.emit("message",s,!0),this._state=ie):(this._state=Ht,setImmediate(()=>{this.emit("message",s,!0),this._state=ie,this.startLoop(e)}))}else{let s=vn(n,t);if(!this._skipUTF8Validation&&!Zs(s)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(i);return}this._state===wn||this._allowSynchronousEvents?(this.emit("message",s,!1),this._state=ie):(this._state=Ht,setImmediate(()=>{this.emit("message",s,!1),this._state=ie,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,Qs),this.end();else{let n=e.readUInt16BE(0);if(!ba(n)){let i=this.createError(RangeError,`invalid status code ${n}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(i);return}let s=new zt(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Zs(s)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(i);return}this._loop=!1,this.emit("conclude",n,s),this.end()}this._state=ie;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=ie):(this._state=Ht,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=ie,this.startLoop(t)}))}createError(e,t,n,s,i){this._loop=!1,this._errored=!0;let a=new e(n?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(a,this.createError),a.code=i,a[ma]=s,a}};ni.exports=xn});var Pn=R((xu,oi)=>{"use strict";var{Duplex:wu}=require("stream"),{randomFillSync:Sa}=require("crypto"),si=lt(),{EMPTY_BUFFER:va,kWebSocket:Ea,NOOP:wa}=he(),{isBlob:Ye,isValidStatusCode:xa}=Je(),{mask:ii,toBuffer:ke}=ct(),oe=Symbol("kByteLength"),Ta=Buffer.alloc(4),Jt=8*1024,Re,Ke=Jt,ue=0,Oa=1,Ca=2,On=class r{constructor(e,t,n){this._extensions=t||{},n&&(this._generateMask=n,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=ue,this.onerror=wa,this[Ea]=void 0}static frame(e,t){let n,s=!1,i=2,a=!1;t.mask&&(n=t.maskBuffer||Ta,t.generateMask?t.generateMask(n):(Ke===Jt&&(Re===void 0&&(Re=Buffer.alloc(Jt)),Sa(Re,0,Jt),Ke=0),n[0]=Re[Ke++],n[1]=Re[Ke++],n[2]=Re[Ke++],n[3]=Re[Ke++]),a=(n[0]|n[1]|n[2]|n[3])===0,i=6);let f;typeof e=="string"?(!t.mask||a)&&t[oe]!==void 0?f=t[oe]:(e=Buffer.from(e),f=e.length):(f=e.length,s=t.mask&&t.readOnly&&!a);let h=f;f>=65536?(i+=8,h=127):f>125&&(i+=2,h=126);let l=Buffer.allocUnsafe(s?f+i:i);return l[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(l[0]|=64),l[1]=h,h===126?l.writeUInt16BE(f,2):h===127&&(l[2]=l[3]=0,l.writeUIntBE(f,4,6)),t.mask?(l[1]|=128,l[i-4]=n[0],l[i-3]=n[1],l[i-2]=n[2],l[i-1]=n[3],a?[l,e]:s?(ii(e,n,l,i,f),[l]):(ii(e,n,e,0,f),[l,e])):[l,e]}close(e,t,n,s){let i;if(e===void 0)i=va;else{if(typeof e!="number"||!xa(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let f=Buffer.byteLength(t);if(f>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+f),i.writeUInt16BE(e,0),typeof t=="string"?i.write(t,2):i.set(t,2)}}let a={[oe]:i.length,fin:!0,generateMask:this._generateMask,mask:n,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._state!==ue?this.enqueue([this.dispatch,i,!1,a,s]):this.sendFrame(r.frame(i,a),s)}ping(e,t,n){let s,i;if(typeof e=="string"?(s=Buffer.byteLength(e),i=!1):Ye(e)?(s=e.size,i=!1):(e=ke(e),s=e.length,i=ke.readOnly),s>125)throw new RangeError("The data size must not be greater than 125 bytes");let a={[oe]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};Ye(e)?this._state!==ue?this.enqueue([this.getBlobData,e,!1,a,n]):this.getBlobData(e,!1,a,n):this._state!==ue?this.enqueue([this.dispatch,e,!1,a,n]):this.sendFrame(r.frame(e,a),n)}pong(e,t,n){let s,i;if(typeof e=="string"?(s=Buffer.byteLength(e),i=!1):Ye(e)?(s=e.size,i=!1):(e=ke(e),s=e.length,i=ke.readOnly),s>125)throw new RangeError("The data size must not be greater than 125 bytes");let a={[oe]:s,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};Ye(e)?this._state!==ue?this.enqueue([this.getBlobData,e,!1,a,n]):this.getBlobData(e,!1,a,n):this._state!==ue?this.enqueue([this.dispatch,e,!1,a,n]):this.sendFrame(r.frame(e,a),n)}send(e,t,n){let s=this._extensions[si.extensionName],i=t.binary?2:1,a=t.compress,f,h;typeof e=="string"?(f=Buffer.byteLength(e),h=!1):Ye(e)?(f=e.size,h=!1):(e=ke(e),f=e.length,h=ke.readOnly),this._firstFragment?(this._firstFragment=!1,a&&s&&s.params[s._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(a=f>=s._threshold),this._compress=a):(a=!1,i=0),t.fin&&(this._firstFragment=!0);let l={[oe]:f,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:h,rsv1:a};Ye(e)?this._state!==ue?this.enqueue([this.getBlobData,e,this._compress,l,n]):this.getBlobData(e,this._compress,l,n):this._state!==ue?this.enqueue([this.dispatch,e,this._compress,l,n]):this.dispatch(e,this._compress,l,n)}getBlobData(e,t,n,s){this._bufferedBytes+=n[oe],this._state=Ca,e.arrayBuffer().then(i=>{if(this._socket.destroyed){let f=new Error("The socket was closed while the blob was being read");process.nextTick(Cn,this,f,s);return}this._bufferedBytes-=n[oe];let a=ke(i);t?this.dispatch(a,t,n,s):(this._state=ue,this.sendFrame(r.frame(a,n),s),this.dequeue())}).catch(i=>{process.nextTick(Pa,this,i,s)})}dispatch(e,t,n,s){if(!t){this.sendFrame(r.frame(e,n),s);return}let i=this._extensions[si.extensionName];this._bufferedBytes+=n[oe],this._state=Oa,i.compress(e,n.fin,(a,f)=>{if(this._socket.destroyed){let h=new Error("The socket was closed while data was being compressed");Cn(this,h,s);return}this._bufferedBytes-=n[oe],this._state=ue,n.readOnly=!1,this.sendFrame(r.frame(f,n),s),this.dequeue()})}dequeue(){for(;this._state===ue&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][oe],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][oe],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};oi.exports=On;function Cn(r,e,t){typeof t=="function"&&t(e);for(let n=0;n<r._queue.length;n++){let s=r._queue[n],i=s[s.length-1];typeof i=="function"&&i(e)}}function Pa(r,e,t){Cn(r,e,t),r.onerror(e)}});var mi=R((Tu,pi)=>{"use strict";var{kForOnEventAttribute:ft,kListener:kn}=he(),ai=Symbol("kCode"),ci=Symbol("kData"),ui=Symbol("kError"),li=Symbol("kMessage"),fi=Symbol("kReason"),Xe=Symbol("kTarget"),di=Symbol("kType"),hi=Symbol("kWasClean"),me=class{constructor(e){this[Xe]=null,this[di]=e}get target(){return this[Xe]}get type(){return this[di]}};Object.defineProperty(me.prototype,"target",{enumerable:!0});Object.defineProperty(me.prototype,"type",{enumerable:!0});var Ne=class extends me{constructor(e,t={}){super(e),this[ai]=t.code===void 0?0:t.code,this[fi]=t.reason===void 0?"":t.reason,this[hi]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[ai]}get reason(){return this[fi]}get wasClean(){return this[hi]}};Object.defineProperty(Ne.prototype,"code",{enumerable:!0});Object.defineProperty(Ne.prototype,"reason",{enumerable:!0});Object.defineProperty(Ne.prototype,"wasClean",{enumerable:!0});var Qe=class extends me{constructor(e,t={}){super(e),this[ui]=t.error===void 0?null:t.error,this[li]=t.message===void 0?"":t.message}get error(){return this[ui]}get message(){return this[li]}};Object.defineProperty(Qe.prototype,"error",{enumerable:!0});Object.defineProperty(Qe.prototype,"message",{enumerable:!0});var dt=class extends me{constructor(e,t={}){super(e),this[ci]=t.data===void 0?null:t.data}get data(){return this[ci]}};Object.defineProperty(dt.prototype,"data",{enumerable:!0});var ka={addEventListener(r,e,t={}){for(let s of this.listeners(r))if(!t[ft]&&s[kn]===e&&!s[ft])return;let n;if(r==="message")n=function(i,a){let f=new dt("message",{data:a?i:i.toString()});f[Xe]=this,Yt(e,this,f)};else if(r==="close")n=function(i,a){let f=new Ne("close",{code:i,reason:a.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});f[Xe]=this,Yt(e,this,f)};else if(r==="error")n=function(i){let a=new Qe("error",{error:i,message:i.message});a[Xe]=this,Yt(e,this,a)};else if(r==="open")n=function(){let i=new me("open");i[Xe]=this,Yt(e,this,i)};else return;n[ft]=!!t[ft],n[kn]=e,t.once?this.once(r,n):this.on(r,n)},removeEventListener(r,e){for(let t of this.listeners(r))if(t[kn]===e&&!t[ft]){this.removeListener(r,t);break}}};pi.exports={CloseEvent:Ne,ErrorEvent:Qe,Event:me,EventTarget:ka,MessageEvent:dt};function Yt(r,e,t){typeof r=="object"&&r.handleEvent?r.handleEvent.call(r,t):r.call(e,t)}});var Rn=R((Ou,_i)=>{"use strict";var{tokenChars:ht}=Je();function fe(r,e,t){r[e]===void 0?r[e]=[t]:r[e].push(t)}function Ra(r){let e=Object.create(null),t=Object.create(null),n=!1,s=!1,i=!1,a,f,h=-1,l=-1,g=-1,p=0;for(;p<r.length;p++)if(l=r.charCodeAt(p),a===void 0)if(g===-1&&ht[l]===1)h===-1&&(h=p);else if(p!==0&&(l===32||l===9))g===-1&&h!==-1&&(g=p);else if(l===59||l===44){if(h===-1)throw new SyntaxError(`Unexpected character at index ${p}`);g===-1&&(g=p);let S=r.slice(h,g);l===44?(fe(e,S,t),t=Object.create(null)):a=S,h=g=-1}else throw new SyntaxError(`Unexpected character at index ${p}`);else if(f===void 0)if(g===-1&&ht[l]===1)h===-1&&(h=p);else if(l===32||l===9)g===-1&&h!==-1&&(g=p);else if(l===59||l===44){if(h===-1)throw new SyntaxError(`Unexpected character at index ${p}`);g===-1&&(g=p),fe(t,r.slice(h,g),!0),l===44&&(fe(e,a,t),t=Object.create(null),a=void 0),h=g=-1}else if(l===61&&h!==-1&&g===-1)f=r.slice(h,p),h=g=-1;else throw new SyntaxError(`Unexpected character at index ${p}`);else if(s){if(ht[l]!==1)throw new SyntaxError(`Unexpected character at index ${p}`);h===-1?h=p:n||(n=!0),s=!1}else if(i)if(ht[l]===1)h===-1&&(h=p);else if(l===34&&h!==-1)i=!1,g=p;else if(l===92)s=!0;else throw new SyntaxError(`Unexpected character at index ${p}`);else if(l===34&&r.charCodeAt(p-1)===61)i=!0;else if(g===-1&&ht[l]===1)h===-1&&(h=p);else if(h!==-1&&(l===32||l===9))g===-1&&(g=p);else if(l===59||l===44){if(h===-1)throw new SyntaxError(`Unexpected character at index ${p}`);g===-1&&(g=p);let S=r.slice(h,g);n&&(S=S.replace(/\\/g,""),n=!1),fe(t,f,S),l===44&&(fe(e,a,t),t=Object.create(null),a=void 0),f=void 0,h=g=-1}else throw new SyntaxError(`Unexpected character at index ${p}`);if(h===-1||i||l===32||l===9)throw new SyntaxError("Unexpected end of input");g===-1&&(g=p);let m=r.slice(h,g);return a===void 0?fe(e,m,t):(f===void 0?fe(t,m,!0):n?fe(t,f,m.replace(/\\/g,"")):fe(t,f,m),fe(e,a,t)),e}function Na(r){return Object.keys(r).map(e=>{let t=r[e];return Array.isArray(t)||(t=[t]),t.map(n=>[e].concat(Object.keys(n).map(s=>{let i=n[s];return Array.isArray(i)||(i=[i]),i.map(a=>a===!0?s:`${s}=${a}`).join("; ")})).join("; ")).join(", ")}).join(", ")}_i.exports={format:Na,parse:Ra}});var Zt=R((ku,Pi)=>{"use strict";var La=require("events"),Ma=require("https"),ja=require("http"),bi=require("net"),Ia=require("tls"),{randomBytes:Da,createHash:qa}=require("crypto"),{Duplex:Cu,Readable:Pu}=require("stream"),{URL:Nn}=require("url"),Te=lt(),Ba=Tn(),Aa=Pn(),{isBlob:$a}=Je(),{BINARY_TYPES:gi,EMPTY_BUFFER:Kt,GUID:Wa,kForOnEventAttribute:Ln,kListener:Ua,kStatusCode:Fa,kWebSocket:H,NOOP:Si}=he(),{EventTarget:{addEventListener:Va,removeEventListener:Ga}}=mi(),{format:za,parse:Ha}=Rn(),{toBuffer:Ja}=ct(),Ya=30*1e3,vi=Symbol("kAborted"),Mn=[8,13],_e=["CONNECTING","OPEN","CLOSING","CLOSED"],Ka=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,A=class r extends La{constructor(e,t,n){super(),this._binaryType=gi[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=Kt,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=r.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(n=t,t=[]):t=[t]),Ei(this,e,t,n)):(this._autoPong=n.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){gi.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,n){let s=new Ba({allowSynchronousEvents:n.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation}),i=new Aa(e,this._extensions,n.generateMask);this._receiver=s,this._sender=i,this._socket=e,s[H]=this,i[H]=this,e[H]=this,s.on("conclude",Za),s.on("drain",ec),s.on("error",tc),s.on("message",rc),s.on("ping",nc),s.on("pong",sc),i.onerror=ic,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Ti),e.on("data",Qt),e.on("end",Oi),e.on("error",Ci),this._readyState=r.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=r.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[Te.extensionName]&&this._extensions[Te.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=r.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==r.CLOSED){if(this.readyState===r.CONNECTING){se(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===r.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=r.CLOSING,this._sender.close(e,t,!this._isServer,n=>{n||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),xi(this)}}pause(){this.readyState===r.CONNECTING||this.readyState===r.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,n){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(n=e,e=t=void 0):typeof t=="function"&&(n=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){jn(this,e,n);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||Kt,t,n)}pong(e,t,n){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(n=e,e=t=void 0):typeof t=="function"&&(n=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){jn(this,e,n);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||Kt,t,n)}resume(){this.readyState===r.CONNECTING||this.readyState===r.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,n){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(n=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){jn(this,e,n);return}let s={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Te.extensionName]||(s.compress=!1),this._sender.send(e||Kt,s,n)}terminate(){if(this.readyState!==r.CLOSED){if(this.readyState===r.CONNECTING){se(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=r.CLOSING,this._socket.destroy())}}};Object.defineProperty(A,"CONNECTING",{enumerable:!0,value:_e.indexOf("CONNECTING")});Object.defineProperty(A.prototype,"CONNECTING",{enumerable:!0,value:_e.indexOf("CONNECTING")});Object.defineProperty(A,"OPEN",{enumerable:!0,value:_e.indexOf("OPEN")});Object.defineProperty(A.prototype,"OPEN",{enumerable:!0,value:_e.indexOf("OPEN")});Object.defineProperty(A,"CLOSING",{enumerable:!0,value:_e.indexOf("CLOSING")});Object.defineProperty(A.prototype,"CLOSING",{enumerable:!0,value:_e.indexOf("CLOSING")});Object.defineProperty(A,"CLOSED",{enumerable:!0,value:_e.indexOf("CLOSED")});Object.defineProperty(A.prototype,"CLOSED",{enumerable:!0,value:_e.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(r=>{Object.defineProperty(A.prototype,r,{enumerable:!0})});["open","error","close","message"].forEach(r=>{Object.defineProperty(A.prototype,`on${r}`,{enumerable:!0,get(){for(let e of this.listeners(r))if(e[Ln])return e[Ua];return null},set(e){for(let t of this.listeners(r))if(t[Ln]){this.removeListener(r,t);break}typeof e=="function"&&this.addEventListener(r,e,{[Ln]:!0})}})});A.prototype.addEventListener=Va;A.prototype.removeEventListener=Ga;Pi.exports=A;function Ei(r,e,t,n){let s={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:Mn[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(r._autoPong=s.autoPong,!Mn.includes(s.protocolVersion))throw new RangeError(`Unsupported protocol version: ${s.protocolVersion} (supported versions: ${Mn.join(", ")})`);let i;if(e instanceof Nn)i=e;else try{i=new Nn(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}i.protocol==="http:"?i.protocol="ws:":i.protocol==="https:"&&(i.protocol="wss:"),r._url=i.href;let a=i.protocol==="wss:",f=i.protocol==="ws+unix:",h;if(i.protocol!=="ws:"&&!a&&!f?h=`The URL's protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"`:f&&!i.pathname?h="The URL's pathname is empty":i.hash&&(h="The URL contains a fragment identifier"),h){let w=new SyntaxError(h);if(r._redirects===0)throw w;Xt(r,w);return}let l=a?443:80,g=Da(16).toString("base64"),p=a?Ma.request:ja.request,m=new Set,S;if(s.createConnection=s.createConnection||(a?Qa:Xa),s.defaultPort=s.defaultPort||l,s.port=i.port||l,s.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,s.headers={...s.headers,"Sec-WebSocket-Version":s.protocolVersion,"Sec-WebSocket-Key":g,Connection:"Upgrade",Upgrade:"websocket"},s.path=i.pathname+i.search,s.timeout=s.handshakeTimeout,s.perMessageDeflate&&(S=new Te(s.perMessageDeflate!==!0?s.perMessageDeflate:{},!1,s.maxPayload),s.headers["Sec-WebSocket-Extensions"]=za({[Te.extensionName]:S.offer()})),t.length){for(let w of t){if(typeof w!="string"||!Ka.test(w)||m.has(w))throw new SyntaxError("An invalid or duplicated subprotocol was specified");m.add(w)}s.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(s.origin&&(s.protocolVersion<13?s.headers["Sec-WebSocket-Origin"]=s.origin:s.headers.Origin=s.origin),(i.username||i.password)&&(s.auth=`${i.username}:${i.password}`),f){let w=s.path.split(":");s.socketPath=w[0],s.path=w[1]}let O;if(s.followRedirects){if(r._redirects===0){r._originalIpc=f,r._originalSecure=a,r._originalHostOrSocketPath=f?s.socketPath:i.host;let w=n&&n.headers;if(n={...n,headers:{}},w)for(let[L,$]of Object.entries(w))n.headers[L.toLowerCase()]=$}else if(r.listenerCount("redirect")===0){let w=f?r._originalIpc?s.socketPath===r._originalHostOrSocketPath:!1:r._originalIpc?!1:i.host===r._originalHostOrSocketPath;(!w||r._originalSecure&&!a)&&(delete s.headers.authorization,delete s.headers.cookie,w||delete s.headers.host,s.auth=void 0)}s.auth&&!n.headers.authorization&&(n.headers.authorization="Basic "+Buffer.from(s.auth).toString("base64")),O=r._req=p(s),r._redirects&&r.emit("redirect",r.url,O)}else O=r._req=p(s);s.timeout&&O.on("timeout",()=>{se(r,O,"Opening handshake has timed out")}),O.on("error",w=>{O===null||O[vi]||(O=r._req=null,Xt(r,w))}),O.on("response",w=>{let L=w.headers.location,$=w.statusCode;if(L&&s.followRedirects&&$>=300&&$<400){if(++r._redirects>s.maxRedirects){se(r,O,"Maximum redirects exceeded");return}O.abort();let G;try{G=new Nn(L,e)}catch{let b=new SyntaxError(`Invalid URL: ${L}`);Xt(r,b);return}Ei(r,G,t,n)}else r.emit("unexpected-response",O,w)||se(r,O,`Unexpected server response: ${w.statusCode}`)}),O.on("upgrade",(w,L,$)=>{if(r.emit("upgrade",w),r.readyState!==A.CONNECTING)return;O=r._req=null;let G=w.headers.upgrade;if(G===void 0||G.toLowerCase()!=="websocket"){se(r,L,"Invalid Upgrade header");return}let x=qa("sha1").update(g+Wa).digest("base64");if(w.headers["sec-websocket-accept"]!==x){se(r,L,"Invalid Sec-WebSocket-Accept header");return}let b=w.headers["sec-websocket-protocol"],E;if(b!==void 0?m.size?m.has(b)||(E="Server sent an invalid subprotocol"):E="Server sent a subprotocol but none was requested":m.size&&(E="Server sent no subprotocol"),E){se(r,L,E);return}b&&(r._protocol=b);let F=w.headers["sec-websocket-extensions"];if(F!==void 0){if(!S){se(r,L,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let C;try{C=Ha(F)}catch{se(r,L,"Invalid Sec-WebSocket-Extensions header");return}let ae=Object.keys(C);if(ae.length!==1||ae[0]!==Te.extensionName){se(r,L,"Server indicated an extension that was not requested");return}try{S.accept(C[Te.extensionName])}catch{se(r,L,"Invalid Sec-WebSocket-Extensions header");return}r._extensions[Te.extensionName]=S}r.setSocket(L,$,{allowSynchronousEvents:s.allowSynchronousEvents,generateMask:s.generateMask,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation})}),s.finishRequest?s.finishRequest(O,r):O.end()}function Xt(r,e){r._readyState=A.CLOSING,r._errorEmitted=!0,r.emit("error",e),r.emitClose()}function Xa(r){return r.path=r.socketPath,bi.connect(r)}function Qa(r){return r.path=void 0,!r.servername&&r.servername!==""&&(r.servername=bi.isIP(r.host)?"":r.host),Ia.connect(r)}function se(r,e,t){r._readyState=A.CLOSING;let n=new Error(t);Error.captureStackTrace(n,se),e.setHeader?(e[vi]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(Xt,r,n)):(e.destroy(n),e.once("error",r.emit.bind(r,"error")),e.once("close",r.emitClose.bind(r)))}function jn(r,e,t){if(e){let n=$a(e)?e.size:Ja(e).length;r._socket?r._sender._bufferedBytes+=n:r._bufferedAmount+=n}if(t){let n=new Error(`WebSocket is not open: readyState ${r.readyState} (${_e[r.readyState]})`);process.nextTick(t,n)}}function Za(r,e){let t=this[H];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=r,t._socket[H]!==void 0&&(t._socket.removeListener("data",Qt),process.nextTick(wi,t._socket),r===1005?t.close():t.close(r,e))}function ec(){let r=this[H];r.isPaused||r._socket.resume()}function tc(r){let e=this[H];e._socket[H]!==void 0&&(e._socket.removeListener("data",Qt),process.nextTick(wi,e._socket),e.close(r[Fa])),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",r))}function yi(){this[H].emitClose()}function rc(r,e){this[H].emit("message",r,e)}function nc(r){let e=this[H];e._autoPong&&e.pong(r,!this._isServer,Si),e.emit("ping",r)}function sc(r){this[H].emit("pong",r)}function wi(r){r.resume()}function ic(r){let e=this[H];e.readyState!==A.CLOSED&&(e.readyState===A.OPEN&&(e._readyState=A.CLOSING,xi(e)),this._socket.end(),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",r)))}function xi(r){r._closeTimer=setTimeout(r._socket.destroy.bind(r._socket),Ya)}function Ti(){let r=this[H];this.removeListener("close",Ti),this.removeListener("data",Qt),this.removeListener("end",Oi),r._readyState=A.CLOSING;let e;!this._readableState.endEmitted&&!r._closeFrameReceived&&!r._receiver._writableState.errorEmitted&&(e=r._socket.read())!==null&&r._receiver.write(e),r._receiver.end(),this[H]=void 0,clearTimeout(r._closeTimer),r._receiver._writableState.finished||r._receiver._writableState.errorEmitted?r.emitClose():(r._receiver.on("error",yi),r._receiver.on("finish",yi))}function Qt(r){this[H]._receiver.write(r)||this.pause()}function Oi(){let r=this[H];r._readyState=A.CLOSING,r._receiver.end(),this.end()}function Ci(){let r=this[H];this.removeListener("error",Ci),this.on("error",Si),r&&(r._readyState=A.CLOSING,this.destroy())}});var Li=R((Nu,Ni)=>{"use strict";var Ru=Zt(),{Duplex:oc}=require("stream");function ki(r){r.emit("close")}function ac(){!this.destroyed&&this._writableState.finished&&this.destroy()}function Ri(r){this.removeListener("error",Ri),this.destroy(),this.listenerCount("error")===0&&this.emit("error",r)}function cc(r,e){let t=!0,n=new oc({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return r.on("message",function(i,a){let f=!a&&n._readableState.objectMode?i.toString():i;n.push(f)||r.pause()}),r.once("error",function(i){n.destroyed||(t=!1,n.destroy(i))}),r.once("close",function(){n.destroyed||n.push(null)}),n._destroy=function(s,i){if(r.readyState===r.CLOSED){i(s),process.nextTick(ki,n);return}let a=!1;r.once("error",function(h){a=!0,i(h)}),r.once("close",function(){a||i(s),process.nextTick(ki,n)}),t&&r.terminate()},n._final=function(s){if(r.readyState===r.CONNECTING){r.once("open",function(){n._final(s)});return}r._socket!==null&&(r._socket._writableState.finished?(s(),n._readableState.endEmitted&&n.destroy()):(r._socket.once("finish",function(){s()}),r.close()))},n._read=function(){r.isPaused&&r.resume()},n._write=function(s,i,a){if(r.readyState===r.CONNECTING){r.once("open",function(){n._write(s,i,a)});return}r.send(s,a)},n.on("end",ac),n.on("error",Ri),n}Ni.exports=cc});var ji=R((Lu,Mi)=>{"use strict";var{tokenChars:uc}=Je();function lc(r){let e=new Set,t=-1,n=-1,s=0;for(s;s<r.length;s++){let a=r.charCodeAt(s);if(n===-1&&uc[a]===1)t===-1&&(t=s);else if(s!==0&&(a===32||a===9))n===-1&&t!==-1&&(n=s);else if(a===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${s}`);n===-1&&(n=s);let f=r.slice(t,n);if(e.has(f))throw new SyntaxError(`The "${f}" subprotocol is duplicated`);e.add(f),t=n=-1}else throw new SyntaxError(`Unexpected character at index ${s}`)}if(t===-1||n!==-1)throw new SyntaxError("Unexpected end of input");let i=r.slice(t,s);if(e.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return e.add(i),e}Mi.exports={parse:lc}});var Wi=R((ju,$i)=>{"use strict";var fc=require("events"),er=require("http"),{Duplex:Mu}=require("stream"),{createHash:dc}=require("crypto"),Ii=Rn(),Le=lt(),hc=ji(),pc=Zt(),{GUID:mc,kWebSocket:_c}=he(),gc=/^[+/0-9A-Za-z]{22}==$/,Di=0,qi=1,Ai=2,In=class extends fc{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:pc,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=er.createServer((n,s)=>{let i=er.STATUS_CODES[426];s.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),s.end(i)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let n=this.emit.bind(this,"connection");this._removeListeners=yc(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(s,i,a)=>{this.handleUpgrade(s,i,a,n)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=Di}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===Ai){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(pt,this);return}if(e&&this.once("close",e),this._state!==qi)if(this._state=qi,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(pt,this):process.nextTick(pt,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{pt(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,n,s){t.on("error",Bi);let i=e.headers["sec-websocket-key"],a=e.headers.upgrade,f=+e.headers["sec-websocket-version"];if(e.method!=="GET"){Me(this,e,t,405,"Invalid HTTP method");return}if(a===void 0||a.toLowerCase()!=="websocket"){Me(this,e,t,400,"Invalid Upgrade header");return}if(i===void 0||!gc.test(i)){Me(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(f!==13&&f!==8){Me(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"});return}if(!this.shouldHandle(e)){mt(t,400);return}let h=e.headers["sec-websocket-protocol"],l=new Set;if(h!==void 0)try{l=hc.parse(h)}catch{Me(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let g=e.headers["sec-websocket-extensions"],p={};if(this.options.perMessageDeflate&&g!==void 0){let m=new Le(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let S=Ii.parse(g);S[Le.extensionName]&&(m.accept(S[Le.extensionName]),p[Le.extensionName]=m)}catch{Me(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let m={origin:e.headers[`${f===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(m,(S,O,w,L)=>{if(!S)return mt(t,O||401,w,L);this.completeUpgrade(p,i,l,e,t,n,s)});return}if(!this.options.verifyClient(m))return mt(t,401)}this.completeUpgrade(p,i,l,e,t,n,s)}completeUpgrade(e,t,n,s,i,a,f){if(!i.readable||!i.writable)return i.destroy();if(i[_c])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>Di)return mt(i,503);let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${dc("sha1").update(t+mc).digest("base64")}`],g=new this.options.WebSocket(null,void 0,this.options);if(n.size){let p=this.options.handleProtocols?this.options.handleProtocols(n,s):n.values().next().value;p&&(l.push(`Sec-WebSocket-Protocol: ${p}`),g._protocol=p)}if(e[Le.extensionName]){let p=e[Le.extensionName].params,m=Ii.format({[Le.extensionName]:[p]});l.push(`Sec-WebSocket-Extensions: ${m}`),g._extensions=e}this.emit("headers",l,s),i.write(l.concat(`\r
`).join(`\r
`)),i.removeListener("error",Bi),g.setSocket(i,a,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(g),g.on("close",()=>{this.clients.delete(g),this._shouldEmitClose&&!this.clients.size&&process.nextTick(pt,this)})),f(g,s)}};$i.exports=In;function yc(r,e){for(let t of Object.keys(e))r.on(t,e[t]);return function(){for(let n of Object.keys(e))r.removeListener(n,e[n])}}function pt(r){r._state=Ai,r.emit("close")}function Bi(){this.destroy()}function mt(r,e,t,n){t=t||er.STATUS_CODES[e],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...n},r.once("finish",r.destroy),r.end(`HTTP/1.1 ${e} ${er.STATUS_CODES[e]}\r
`+Object.keys(n).map(s=>`${s}: ${n[s]}`).join(`\r
`)+`\r
\r
`+t)}function Me(r,e,t,n,s,i){if(r.listenerCount("wsClientError")){let a=new Error(s);Error.captureStackTrace(a,Me),r.emit("wsClientError",a,t,e)}else mt(t,n,s,i)}});var Oc={};_o(Oc,{parseTypedCommand:()=>Vi});module.exports=go(Oc);var Ze=require("fs/promises"),Ui=require("path"),Fi=ee(Zn());var ks=ee(we(),1);var Gc=ee(we(),1),At=class{disposables=[];dispose(){for(;this.disposables.length!==0;)this.disposables.pop().dispose()}push(e){let t=this.disposables;return t.push(e),{dispose(){let n=t.indexOf(e);n!==-1&&t.splice(n,1)}}}};function Rs(r,e,t){r.forward(e,t),e.forward(r,t),r.onClose(()=>e.dispose()),e.onClose(()=>r.dispose())}function pn(r,e,t,n={}){let s=new At;return r.onClose(()=>s.dispose()),e.onClose(()=>s.dispose()),{reader:r,writer:e,forward(i,a=f=>f){r.listen(f=>{let h=a(f);i.writer.write(h)})},onClose(i){return s.push(ks.Disposable.create(i))},dispose:()=>t(),...n}}var cu=require("net"),uu=require("stream"),Is=ee(require("child_process"),1),Ge=ee(Ls(),1);var eu=ee(we(),1),Ms=ee(we(),1),$t=class extends Ms.AbstractMessageReader{socket;state="initial";callback;events=[];constructor(e){super(),this.socket=e,this.socket.onMessage(t=>this.readMessage(t)),this.socket.onError(t=>this.fireError(t)),this.socket.onClose((t,n)=>{if(t!==1e3){let s={name:""+t,message:`Error during socket reconnect: code = ${t}, reason = ${n}`};this.fireError(s)}this.fireClose()})}listen(e){if(this.state==="initial")for(this.state="listening",this.callback=e;this.events.length!==0;){let t=this.events.pop();t.message!==void 0?this.readMessage(t.message):t.error!==void 0?this.fireError(t.error):this.fireClose()}return{dispose:()=>{this.callback===e&&(this.state="initial",this.callback=void 0)}}}dispose(){super.dispose(),this.state="initial",this.callback=void 0,this.events.splice(0,this.events.length)}readMessage(e){if(this.state==="initial")this.events.splice(0,0,{message:e});else if(this.state==="listening")try{let t=JSON.parse(e);this.callback(t)}catch(t){let n={name:"400",message:`Error during message parsing, reason = ${typeof t=="object"?t.message:"unknown"}`};this.fireError(n)}}fireError(e){this.state==="initial"?this.events.splice(0,0,{error:e}):this.state==="listening"&&super.fireError(e)}fireClose(){this.state==="initial"?this.events.splice(0,0,{}):this.state==="listening"&&super.fireClose(),this.state="closed"}};var su=ee(we(),1),js=ee(we(),1),Wt=class extends js.AbstractMessageWriter{errorCount=0;socket;constructor(e){super(),this.socket=e}end(){}async write(e){try{let t=JSON.stringify(e);this.socket.send(t)}catch(t){this.errorCount++,this.fireError(t,e,this.errorCount)}}};function Ds(r,e,t,n){let s=Is.spawn(e,t||[],n||{});return s.on("error",i=>console.error(`Launching ${r} Server failed: ${i}`)),s.stderr!==null&&s.stderr.on("data",i=>console.error(`${r} Server: ${i}`)),Zo(s)}function qs(r){let e=new $t(r),t=new Wt(r);return pn(e,t,()=>r.dispose(),{socket:r})}function Zo(r){if(r.stdout!==null&&r.stdin!==null)return ea(r.stdout,r.stdin,()=>r.kill())}function ea(r,e,t){let n=new Ge.StreamMessageReader(r),s=new Ge.StreamMessageWriter(e);return pn(n,s,t)}var bc=ee(Li(),1),Sc=ee(Tn(),1),vc=ee(Pn(),1),Ec=ee(Zt(),1),Dn=ee(Wi(),1);var qn=class r{constructor(e){this.logFilePath=e;this.logFilePath=e}static async create(e){return await(0,Ze.mkdir)((0,Ui.dirname)(e),{recursive:!0}),await(0,Ze.writeFile)(e,""),new r(e)}async appendToLogFile(...e){let t=e.join(" ");try{await(0,Ze.appendFile)(this.logFilePath,`${t}
`)}catch(n){console.error("Failed to write to log file:",n)}}debug(...e){console.log(...e),this.appendToLogFile("[DEBUG]",...e)}log(...e){console.log(...e),this.appendToLogFile("[INFO]",...e)}error(...e){console.error(...e),this.appendToLogFile("[ERROR]",...e)}},Bn=class{constructor(e,t){this.webSocket=e;this.logger=t;this.webSocket=e,this.logger=t}send(e){try{this.webSocket.send(e),this.logger.debug("Sent message:",e)}catch(t){this.logger.error("Failed to send message:",t)}}onMessage(e){this.webSocket.onmessage=t=>{try{e(t.data),this.logger.debug("Received message:",t.data)}catch(n){this.logger.error("Error handling message:",n)}}}onError(e){this.webSocket.onerror=t=>{this.logger.error("WebSocket error:",t),"message"in t&&e(t.message)}}onClose(e){this.webSocket.onclose=t=>{this.logger.log(`WebSocket closed with code ${t.code}: ${t.reason}`),e(t.code,t.reason)}}dispose(){this.webSocket.close()}};function Vi(r){if(!r.includes(":"))return r.split(" ");let e=r.indexOf(":"),t=r.substring(0,e),n=r.substring(e+1);switch(t){case"copilot":return["node",n,"--stdio"];case"basedpyright":return[n,"--stdio"];case"ty":return[n,"server"];default:throw new Error(`Unknown LSP server type: ${t}`)}}function wc(r,e,t,n){if(!r){t.close();return}let s=Ds(r.join(" "),r[0],r.slice(1));if(!s)throw new Error("Not able to create json-rpc connection.");let i=new Bn(t,e),a=qs(i);Rs(a,s),i.onClose(()=>{s.dispose(),a.dispose()}),a.onClose(()=>{s.dispose(),i.dispose()})}function xc(r,e,t){let n=new Dn.default({port:r,perMessageDeflate:!1});n.on("error",s=>{t.error("WebSocket server error:",s)}),n.on("connection",(s,i)=>{t.log(`New connection from ${i.socket.remoteAddress}`);try{wc(e,t,s,i)}catch(a){t.error("Failed to start WebSocket bridge:",a),s.close()}})}async function Tc(){let r=(0,Fi.default)(process.argv);if(r.help){console.log('Usage: node index.cjs --log-file <path> --lsp "<command>" [--port <port>]');return}let e=r["log-file"]||"/tmp/lsp-server.log",t=await qn.create(e),n=Number.parseInt(r.port,10)||3e3,s=Vi(r.lsp||"echo test");t.log(`Parsed LSP command: ${s.join(" ")}`),xc(n,s,t)}Tc();0&&(module.exports={parseTypedCommand});
